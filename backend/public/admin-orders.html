<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Kurye App - Bug√ºn√ºn Sipari≈üleri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 2rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .card { background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-item { background: #f7f7f7; padding: 1rem; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.8rem; color: #666; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background: #f9f9f9; font-weight: 600; }
        .badge { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; }
        .badge-bekleniyor { background-color: #fef3c7; color: #92400e; }
        .badge-kuryede { background-color: #dbeafe; color: #1e40af; }
        .badge-teslim_edildi { background-color: #dcfce7; color: #166534; }
        .badge-iptal_edildi { background-color: #fee2e2; color: #991b1b; }
        .badge-onay_bekliyor { background-color: #e0e7ff; color: #3730a3; }
        .badge-onay-bekliyor { background-color: #e0e7ff; color: #3730a3; }

        .countdown {
            font-weight: bold;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            display: inline-block;
            width: 70px;
            text-align: center;
        }
        .countdown-urgent { background: #fee2e2; color: #991b1b; }
        .countdown-warning { background: #fef3c7; color: #92400e; }
        .countdown-normal { background: #dcfce7; color: #166534; }
        .countdown-expired { background: #e5e7eb; color: #4b5563; }

        /* General Button Styles */
        .btn {
            background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .btn:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
        }

        .modal-body {
            padding: 15px 0;
        }
        
        #modal-body-content .form-group {
            margin-bottom: 1rem;
        }
        #modal-body-content label {
            display: block;
            margin-bottom: .5rem;
            font-weight: 600;
        }
        #modal-body-content input, #modal-body-content select {
            width: 100%;
            padding: .5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Status Filter Buttons */
        .status-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .status-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .status-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .status-btn.active {
            background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
            color: white;
            border-color: #667eea;
        }
        .status-btn-all { border-color: #6b7280; }
        .status-btn-all.active { background: #6b7280; }
        .status-btn-waiting { border-color: #f59e0b; }
        .status-btn-waiting.active { background: #f59e0b; }
        .status-btn-courier { border-color: #3b82f6; }
        .status-btn-courier.active { background: #3b82f6; }
        .status-btn-approval { border-color: #8b5cf6; }
        .status-btn-approval.active { background: #8b5cf6; }

        .refresh-btn {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            margin-bottom: 1rem;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main-layout.js"></script>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <!-- Bug√ºn√ºn Tarih Ba≈ülƒ±ƒüƒ± -->
            <div class="card" style="text-align: center; margin-bottom: 1rem;">
                <h2 style="margin: 0; color: #667eea; font-size: 1.5rem;">
                    <i class="fas fa-calendar-day"></i> Bug√ºn√ºn Sipari≈üleri
                </h2>
                <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 1rem;" id="current-date"></p>
                <p style="margin: 0.5rem 0 0 0; color: #333; font-size: 0.9rem;">00:00 - 23:59 Arasƒ± Sipari≈üler</p>
            </div>
            
            <!-- Yenile Butonu -->
            <div class="card" style="text-align: center;">
                <button class="btn refresh-btn" onclick="fetchOrders()">
                    <i class="fas fa-sync-alt"></i> Yenile
                </button>
            </div>
            
            <!-- Status Filter Buttons -->
            <div class="card">
                <div class="status-buttons">
                    <button class="status-btn status-btn-all active" onclick="filterByStatus('')">
                        <i class="fas fa-list"></i> T√ºm√º
                    </button>
                    <button class="status-btn status-btn-waiting" onclick="filterByStatus('bekleniyor')">
                        <i class="fas fa-clock"></i> Bekleniyor
                    </button>
                    <button class="status-btn status-btn-courier" onclick="filterByStatus('kuryede')">
                        <i class="fas fa-motorcycle"></i> Kuryede
                    </button>
                    <button class="status-btn status-btn-approval" onclick="filterByStatus('onay bekliyor')">
                        <i class="fas fa-hourglass-half"></i> Onay Bekliyor
                    </button>
                </div>
            </div>
            
            <div class="card stats-bar" id="stats-container"></div>
            <div class="card">
                <div class="table-container">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Restoran</th>
                                <th>Mahalle</th>
                                <th>Kurye</th>
                                <th>Restoran Fiyatƒ±</th>
                                <th>Kurye Fiyatƒ±</th>
                                <th>Durum</th>
                                <th>√ñdeme</th>
                                <th>Tarih</th>
                                <th>Teslimat S√ºresi</th>
                                <th>Kalan S√ºre</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Sipari≈ü Detaylarƒ±</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Content will be injected by JavaScript -->
            </div>
            <div class="modal-footer" style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                 <button class="btn" id="modal-submit-btn" style="display:none;">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content" style="max-width: 90%; width: auto; background: transparent; border: none; box-shadow: none;">
            <div style="text-align: center; position: relative;">
                <span class="close" onclick="closeImageModal()" style="position: absolute; top: -40px; right: 0; font-size: 40px; color: white; text-shadow: 0 0 10px rgba(0,0,0,0.8);">&times;</span>
                <img id="modal-image" src="" alt="Sipari≈ü Resmi" style="max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
            </div>
        </div>
    </div>

    <script>
        // üîê Admin ≈üifre kontrol√º (JWT token tabanlƒ±)
        function checkAdminAuth() {
            const token = localStorage.getItem('token');
            const oldAuth = localStorage.getItem('adminAuth');
            
            // JWT token varsa ge√ßerli
            if (token) {
                return true;
            }
            
            // Eski adminAuth sistemi de kontrol et (geriye uyumluluk)
            if (oldAuth === 'authenticated') {
                return true;
            }
            
            // Token yok, login sayfasƒ±na y√∂nlendir
            window.location.href = 'admin-login.html';
            return false;
        }
        
        // Sayfa y√ºklendiƒüinde ≈üifre kontrol et
        if (!checkAdminAuth()) {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: white; font-size: 1.2rem;">üîê Yetki kontrol√º yapƒ±lƒ±yor...</div>';
        }

        let API_BASE; // Define API_BASE globally but without immediate assignment
        const socket = io();
        let allOrders = [];
        let currentStatusFilter = ''; // Track current status filter

        // Function to fetch API_BASE from backend
        async function fetchApiBase() {
            try {
                const response = await fetch('/api/admin/config/api-base-url');
                const data = await response.json();
                if (data.success && data.apiBaseUrl) {
                    API_BASE = data.apiBaseUrl;
                    console.log('API_BASE ba≈üarƒ±yla ayarlandƒ±:', API_BASE);
                    
                    // Production ortamƒ±nda force HTTPS
                    if (window.location.protocol === 'https:' && API_BASE.startsWith('http:')) {
                        API_BASE = API_BASE.replace('http:', 'https:');
                        console.log('üîí HTTPS zorlandƒ±, API_BASE g√ºncellendi:', API_BASE);
                    }
                } else {
                    console.error('API_BASE backend tarafƒ±ndan saƒülanamadƒ±:', data.message || 'Bilinmeyen Hata');
                    API_BASE = 'https://kuryex.enucuzal.com'; // Use production HTTPS
                }
            } catch (error) {
                console.error('API_BASE y√ºklenirken hata olu≈ütu:', error);
                API_BASE = 'https://kuryex.enucuzal.com'; // Use production HTTPS on error
            }
        }

        // Helper function to get authorization headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return { 'Content-Type': 'application/json' };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await fetchApiBase(); // Fetch API_BASE first
            updateCurrentDate(); // Bug√ºn√ºn tarihini g√∂ster
            fetchOrders();
            setupMidnightReset(); // Gece yarƒ±sƒ± sƒ±fƒ±rlama ayarla
        });
        
        socket.on('connect', () => {
            console.log('Sipari≈ü sayfasƒ±na baƒülanƒ±ldƒ±.');
        });
        
        socket.on('orderStatusUpdate', (updatedOrder) => {
            console.log('Sipari≈ü durumu g√ºncellendi:', updatedOrder);
            fetchOrders(); // Re-fetch all orders to reflect changes
        });

        socket.on('newOrder', (newOrder) => {
            console.log('Yeni sipari≈ü geldi:', newOrder);
            fetchOrders(); // Re-fetch all orders
        });

        async function fetchOrders() {
            if (!API_BASE) {
                console.log('API_BASE hen√ºz y√ºklenmedi, sipari≈üler bekleniyor...');
                setTimeout(fetchOrders, 1000);
                return;
            }
            
            // DOƒûRU: Tarih, yerel saat dilimine g√∂re doƒüru bir ≈üekilde formatlanƒ±r.
            const localDate = new Date();
            const year = localDate.getFullYear();
            const month = String(localDate.getMonth() + 1).padStart(2, '0');
            const day = String(localDate.getDate()).padStart(2, '0');
            const today = `${year}-${month}-${day}`;

            const queryParams = new URLSearchParams({
                search: '',
                status: currentStatusFilter,
                restaurantId: '',
                courierId: '',
                startDate: today,
                endDate: today
            });

            console.log('üîÑ Bug√ºn√ºn sipari≈üleri y√ºkleniyor (00:00 - 23:59 arasƒ±)...');
            console.log('üåê API URL:', `${API_BASE}/api/admin/orders?${queryParams}`);
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/orders?${queryParams}`, {
                    headers: getAuthHeaders(),
                    mode: 'cors'
                });
                console.log('üì° API Response status:', response.status);
                
                if (!response.ok) {
                    console.error('‚ùå Sipari≈üler √ßekilemedi. Response:', response.status, response.statusText);
                    if (response.status === 401) {
                        document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="12">üîê Yetki hatasƒ± - L√ºtfen tekrar giri≈ü yapƒ±n.</td></tr>';
                        // Redirect to login if unauthorized
                        setTimeout(() => { window.location.href = 'admin-login.html'; }, 2000);
                    } else {
                        document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="12">‚ö†Ô∏è Sipari≈üler y√ºklenirken bir hata olu≈ütu.</td></tr>';
                    }
                    return;
                }
                
                const result = await response.json();
                console.log('üì¶ Full API Response:', result);
                console.log('‚úÖ Bug√ºn√ºn sipari≈üleri y√ºklendi:', result.data?.length || 0, 'adet');
                console.log('üìä Orders data:', result.data);
                allOrders = result.data || [];
                console.log('üóÉÔ∏è allOrders array:', allOrders);
                console.log('üìè allOrders.length:', allOrders.length);
                renderTable(allOrders);
                updateStats(allOrders);
            } catch (error) {
                console.error('‚ùå Network error:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="12">üåê Aƒü hatasƒ±: Sunucuya baƒülanƒ±lamadƒ±. L√ºtfen internet baƒülantƒ±nƒ±zƒ± kontrol edin.</td></tr>';
                } else {
                    document.getElementById('orders-table-body').innerHTML = '<tr><td colspan="12">‚ùå Beklenmeyen hata: ' + error.message + '</td></tr>';
                }
            }
        }

        function setupMidnightReset() {
            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            
            console.log(`‚è∞ Gece yarƒ±sƒ± sƒ±fƒ±rlama ${Math.floor(msUntilMidnight / 1000 / 60)} dakika sonra ayarlandƒ±`);
            
            // Gece yarƒ±sƒ±nda sayfayƒ± yenile
            setTimeout(() => {
                console.log('üîÑ Gece yarƒ±sƒ± - Sayfa yenileniyor...');
                window.location.reload();
            }, msUntilMidnight);
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateString = today.toLocaleDateString('tr-TR', options);
            const titleElem = document.getElementById('current-date');
            if(titleElem) {
                titleElem.textContent = dateString;
            }
        }

        function renderTable(orders) {
            console.log('üé® renderTable called with orders:', orders);
            console.log('üìè Orders length:', orders.length);
            const tableBody = document.getElementById('orders-table-body');
            console.log('üîç Table body element:', tableBody);
            
            if (orders.length === 0) {
                console.log('‚ùå No orders - showing empty message');
                tableBody.innerHTML = '<tr><td colspan="12">Bug√ºn hen√ºz sipari≈ü bulunmamaktadƒ±r.</td></tr>';
                return;
            }
            
            console.log('‚úÖ Rendering', orders.length, 'orders...');

            tableBody.innerHTML = orders.map(order => {
                // Teslimat s√ºresi hesaplama ve g√∂sterimi
                let deliveryTimeDisplay = '-';
                if (order.delivery_time_minutes && order.delivery_time_minutes > 0) {
                    const minutes = Math.round(order.delivery_time_minutes);
                    deliveryTimeDisplay = `<span style="color: #059669; font-weight: 600;">${minutes} dk</span>`;
                } else if (order.status === 'teslim edildi') {
                    deliveryTimeDisplay = '<span style="color: #f59e0b;">Hesaplanamadƒ±</span>';
                }

                return `
                    <tr>
                        <td>#${order.id}</td>
                        <td>${order.firma_name || order.firma_adi || 'N/A'}</td>
                        <td>${order.mahalle || 'N/A'}</td>
                        <td>${order.kurye_name || 'Atanmadƒ±'}</td>
                        <td>‚Ç∫${(parseFloat(order.restaurant_price) || 0).toFixed(2)}</td>
                        <td>‚Ç∫${(parseFloat(order.courier_price) || 0).toFixed(2)}</td>
                        <td><span class="badge badge-${order.status.replace(/ /g, '_')}">${order.status}</span></td>
                        <td>${order.odeme_yontemi}</td>
                        <td>${new Date(order.created_at).toLocaleString('tr-TR')}</td>
                        <td>${deliveryTimeDisplay}</td>
                        <td>${calculateCountdown(order.created_at, order.status)}</td>
                        <td>
                            <button class="btn" onclick='viewOrder(${order.id})'>Detay</button>
                            <button class="btn" onclick='editOrder(${order.id})'>D√ºzenle</button>
                            <button class="btn" onclick='deleteOrder(${order.id})'>Sil</button>
                            ${order.status === 'kuryede' ? `<button class="btn" style="margin-left: 0.5rem;" onclick='returnToPool(${order.id})'>Havuza At</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateCountdown(createdAt, status) {
            if (status === 'teslim edildi' || status === 'iptal edildi') {
                return `<span class="countdown countdown-expired">N/A</span>`;
            }

            // Saat dilimi d√ºzeltmesi olmadan direkt hesapla
            const createdTime = new Date(createdAt);
            const now = new Date();
            const remainingMinutes = 60 - Math.floor((now - createdTime) / 60000); // 60 dakika (1 saat)

            if (remainingMinutes < 0) {
                return `<span class="countdown countdown-expired">S√ºre Doldu</span>`;
            } else if (remainingMinutes <= 15) {
                return `<span class="countdown countdown-urgent">${remainingMinutes} dk</span>`;
            } else if (remainingMinutes <= 30) {
                return `<span class="countdown countdown-warning">${remainingMinutes} dk</span>`;
            } else {
                return `<span class="countdown countdown-normal">${remainingMinutes} dk</span>`;
            }
        }

        // Timestamp operations use database timezone directly

        function updateStats(orders) {
            const statsContainer = document.getElementById('stats-container');
            const statusCounts = orders.reduce((acc, order) => {
                acc[order.status] = (acc[order.status] || 0) + 1;
                return acc;
            }, {});
            // Platform karƒ± hesaplama
            let totalRestaurant = 0;
            let totalCourier = 0;
            orders.forEach(order => {
                totalRestaurant += parseFloat(order.restaurant_price) || 0;
                totalCourier += parseFloat(order.courier_price) || 0;
            });
            const platformProfit = totalRestaurant - totalCourier;

            statsContainer.innerHTML = `
                <div class="stat-item"><div class="stat-value">${orders.length}</div><div class="stat-label">Bug√ºn Toplam</div></div>
                <div class="stat-item"><div class="stat-value">${statusCounts['bekleniyor'] || 0}</div><div class="stat-label">Bekleyen</div></div>
                <div class="stat-item"><div class="stat-value">${statusCounts['kuryede'] || 0}</div><div class="stat-label">Kuryede</div></div>
                <div class="stat-item"><div class="stat-value">${statusCounts['teslim edildi'] || 0}</div><div class="stat-label">Tamamlanan</div></div>
                <div class="stat-item"><div class="stat-value">${statusCounts['iptal edildi'] || 0}</div><div class="stat-label">ƒ∞ptal</div></div>
                <div class="stat-item"><div class="stat-value">‚Ç∫${platformProfit.toFixed(2)}</div><div class="stat-label">Platform Karƒ±</div></div>
            `;
        }
        
        async function viewOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                alert("Sipari≈ü bulunamadƒ±!");
                return;
            }

            document.getElementById('modal-title').innerText = `Sipari≈ü #${order.id} Detaylarƒ±`;
            const modalBody = document.getElementById('modal-body-content');
            
            // Resim URL'sini olu≈ütur (eƒüer resim varsa)
            let imageHtml = '';
            if (order.resim && order.resim.trim() !== '') {
                // Resim URL'si zaten tam URL ise direkt kullan, deƒüilse API_BASE ekle
                let imageUrl = order.resim;
                if (!imageUrl.startsWith('http')) {
                    // Relative path ise API_BASE ekle
                    imageUrl = `${API_BASE}${imageUrl.startsWith('/') ? '' : '/'}${imageUrl}`;
                }
                
                imageHtml = `
                    <div style="margin: 15px 0; text-align: center;">
                        <p><strong>Sipari≈ü Resmi:</strong></p>
                        <img src="${imageUrl}" 
                             alt="Sipari≈ü Resmi" 
                             style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer;"
                             onclick="openImageModal('${imageUrl}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <p style="display: none; color: #666; font-style: italic;">Resim y√ºklenemedi</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <p><strong>Restoran:</strong> ${order.firma_name || order.firma_adi || 'N/A'}</p>
                <p><strong>Mahalle:</strong> ${order.mahalle || 'N/A'}</p>
                <p><strong>Kurye:</strong> ${order.kurye_name || 'Atanmadƒ±'}</p>
                <p><strong>Restoran Fiyatƒ±:</strong> ‚Ç∫${(parseFloat(order.restaurant_price) || 0).toFixed(2)}</p>
                <p><strong>Kurye Fiyatƒ±:</strong> ‚Ç∫${(parseFloat(order.courier_price) || 0).toFixed(2)}</p>
                <p><strong>Hazƒ±rlƒ±k S√ºresi:</strong> ${order.preparation_time === 0 ? 'Hazƒ±r' : (order.preparation_time || 0) + ' dakika'}</p>
                <p><strong>Durum:</strong> ${order.status}</p>
                <p><strong>√ñdeme Y√∂ntemi:</strong> ${order.odeme_yontemi}</p>
                <p><strong>Tarih:</strong> ${new Date(order.created_at).toLocaleString('tr-TR')}</p>
                ${imageHtml}
            `;
            document.getElementById('modal-submit-btn').style.display = 'none';
            document.getElementById('orderModal').style.display = 'block';
        }

        async function editOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                alert("Sipari≈ü bulunamadƒ±!");
                return;
            }

            document.getElementById('modal-title').innerText = `Sipari≈ü #${order.id} D√ºzenle`;
            const modalBody = document.getElementById('modal-body-content');
            
            // Assuming we have lists of couriers and restaurants available
            // Let's fetch them if not already available
            const couriers = await getCouriers();
            const statuses = ['bekleniyor', 'kuryede', 'teslim edildi', 'iptal edildi', 'onay bekliyor'];

            modalBody.innerHTML = `
                <div class="form-group">
                    <label for="edit-tutar">Tutar</label>
                    <input type="number" step="0.01" id="edit-tutar" value="${(parseFloat(order.banka_tutari) || 0).toFixed(2)}">
                </div>
                 <div class="form-group">
                    <label for="edit-restaurant-price">Restoran Fiyatƒ±</label>
                    <input type="number" step="0.01" id="edit-restaurant-price" value="${(parseFloat(order.restaurant_price) || 0).toFixed(2)}">
                </div>
                 <div class="form-group">
                    <label for="edit-courier-price">Kurye Fiyatƒ±</label>
                    <input type="number" step="0.01" id="edit-courier-price" value="${(parseFloat(order.courier_price) || 0).toFixed(2)}">
                </div>
                <div class="form-group">
                    <label for="edit-preparation-time">Hazƒ±rlƒ±k S√ºresi (dakika)</label>
                    <input type="number" id="edit-preparation-time" value="${order.preparation_time || 0}" min="0" max="120">
                </div>
                <div class="form-group">
                    <label for="edit-status">Durum</label>
                    <select id="edit-status">
                        ${statuses.map(s => `<option value="${s}" ${order.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-courier">Kurye</label>
                    <select id="edit-courier">
                        <option value="">Kurye Se√ß</option>
                        ${couriers.map(c => `<option value="${c.id}" ${order.kuryeid === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div id="validation-warning" style="background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 10px; border-radius: 6px; margin-top: 10px; display: none;">
                    <strong>‚ö†Ô∏è Dikkat:</strong> <span id="validation-message"></span>
                </div>
            `;

            // Ger√ßek zamanlƒ± validasyon event listener'larƒ± ekle
            setTimeout(() => {
                const statusSelect = document.getElementById('edit-status');
                const courierSelect = document.getElementById('edit-courier');
                const warningDiv = document.getElementById('validation-warning');
                const warningMessage = document.getElementById('validation-message');

                function validateSelection() {
                    const status = statusSelect.value;
                    const courier = courierSelect.value;
                    const hasValidCourier = courier && courier.trim() !== '' && courier !== 'null';

                    if (status === 'kuryede' && !hasValidCourier) {
                        warningDiv.style.display = 'block';
                        warningMessage.textContent = 'Sipari≈ü durumu "kuryede" se√ßiliyken mutlaka bir kurye se√ßilmelidir!';
                        warningDiv.style.background = '#fee2e2';
                        warningDiv.style.borderColor = '#ef4444';
                        warningDiv.style.color = '#991b1b';
                    } else if (status === 'onay bekliyor' && !hasValidCourier) {
                        warningDiv.style.display = 'block';
                        warningMessage.textContent = 'Sipari≈ü durumu "onay bekliyor" se√ßiliyken mutlaka bir kurye se√ßilmelidir!';
                        warningDiv.style.background = '#fee2e2';
                        warningDiv.style.borderColor = '#ef4444';
                        warningDiv.style.color = '#991b1b';
                    } else if (status === 'bekleniyor' && hasValidCourier) {
                        warningDiv.style.display = 'block';
                        warningMessage.textContent = 'Sipari≈ü durumu "bekleniyor" se√ßiliyken kurye se√ßilmemelidir!';
                        warningDiv.style.background = '#fee2e2';
                        warningDiv.style.borderColor = '#ef4444';
                        warningDiv.style.color = '#991b1b';
                    } else {
                        warningDiv.style.display = 'none';
                    }
                }

                statusSelect.addEventListener('change', validateSelection);
                courierSelect.addEventListener('change', validateSelection);
                
                // ƒ∞lk y√ºklemede de kontrol et
                validateSelection();
            }, 100);

            const submitBtn = document.getElementById('modal-submit-btn');
            submitBtn.style.display = 'block';
            submitBtn.onclick = () => saveOrder(orderId);

            document.getElementById('orderModal').style.display = 'block';
        }

        async function saveOrder(orderId) {
            const status = document.getElementById('edit-status').value;
            const kuryeid = document.getElementById('edit-courier').value;

            // üîç Validasyon Kurallarƒ±
            // Kurye se√ßimini temizle - bo≈ü string veya "null" null olarak ayarla
            const hasValidCourier = kuryeid && kuryeid.trim() !== '' && kuryeid !== 'null';
            
            // Kurye se√ßimi zorunlu olan durumlar
            if (status === 'kuryede') {
                if (!hasValidCourier) {
                    alert('‚ùå UYARI: Sipari≈ü durumu "kuryede" se√ßiliyken mutlaka bir kurye se√ßilmelidir!\n\nL√ºtfen kurye se√ßiniz veya sipari≈ü durumunu deƒüi≈ütiriniz.');
                    return;
                }
            }

            if (status === 'onay bekliyor') {
                if (!hasValidCourier) {
                    alert('‚ùå UYARI: Sipari≈ü durumu "onay bekliyor" se√ßiliyken mutlaka bir kurye se√ßilmelidir!\n\nOnay bekleyen sipari≈ülerin bir kurye atamasƒ± bulunmalƒ±dƒ±r.\n\nL√ºtfen kurye se√ßiniz veya sipari≈ü durumunu deƒüi≈ütiriniz.');
                    return;
                }
            }

            // Kurye se√ßimi olmamasƒ± gereken durumlar
            if (status === 'bekleniyor') {
                if (hasValidCourier) {
                    alert('‚ùå UYARI: Sipari≈ü durumu "bekleniyor" se√ßiliyken kurye se√ßilmemelidir!\n\nSipari≈ü havuza d√º≈üt√ºƒü√ºnde kurye atamasƒ± otomatik olarak kaldƒ±rƒ±lƒ±r.\n\nL√ºtfen kurye se√ßimini kaldƒ±rƒ±nƒ±z veya sipari≈ü durumunu deƒüi≈ütiriniz.');
                    return;
                }
            }

            // ‚úÖ Validasyon Ba≈üarƒ±lƒ± - Sipari≈ü G√ºncelleniyor
            const payload = {
                tutar: document.getElementById('edit-tutar').value,
                restaurant_price: document.getElementById('edit-restaurant-price').value,
                courier_price: document.getElementById('edit-courier-price').value,
                preparation_time: document.getElementById('edit-preparation-time').value,
                status: status,
                kuryeid: hasValidCourier ? kuryeid : null, // Ge√ßerli kurye varsa ID'sini, yoksa null g√∂nder
            };

            console.log('üîç G√∂nderilecek payload:', payload);

            try {
                const response = await fetch(`${API_BASE}/api/admin/orders/${orderId}`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    closeModal();
                    fetchOrders();
                    
                    // Ba≈üarƒ± mesajƒ±
                    if (status === 'kuryede') {
                        alert('‚úÖ Sipari≈ü kurye atamasƒ± ile ba≈üarƒ±yla g√ºncellendi!');
                    } else if (status === 'onay bekliyor') {
                        alert('‚úÖ Sipari≈ü onay bekleme durumuna kurye atamasƒ± ile ba≈üarƒ±yla g√ºncellendi!');
                    } else if (status === 'bekleniyor') {
                        alert('‚úÖ Sipari≈ü havuza ba≈üarƒ±yla atƒ±ldƒ±!');
                    } else {
                        alert('‚úÖ Sipari≈ü ba≈üarƒ±yla g√ºncellendi!');
                    }
                } else {
                    let errorMessage = 'Sipari≈ü g√ºncellenirken bir hata olu≈ütu';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Error response JSON parse hatasƒ±:', e);
                    }
                    alert(`‚ùå Hata: ${errorMessage}`);
                }
            } catch (error) {
                console.error('Sipari≈ü g√ºncellenirken hata:', error);
                alert('‚ùå Sipari≈ü g√ºncellenirken bir aƒü hatasƒ± olu≈ütu.');
            }
        }

        async function getCouriers() {
            if (!API_BASE) {
                console.log('API_BASE hen√ºz y√ºklenmedi, kuryeler bekleniyor...');
                return [];
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/admin/couriers`, {
                    headers: getAuthHeaders(),
                    mode: 'cors'
                });
                if(res.ok) {
                    const { data } = await res.json();
                    return data;
                }
            } catch(e) {
                console.error("Kuryeler √ßekilemedi", e);
                return [];
            }
            return [];
        }

        async function deleteOrder(orderId) {
            if (confirm(`Sipari≈ü ID ${orderId}'i silmek istediƒüinizden emin misiniz?`)) {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/orders/${orderId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });

                    if (response.ok) {
                        console.log(`Sipari≈ü ${orderId} silindi.`);
                        fetchOrders(); // Refresh the table
                    } else {
                        let errorMessage = 'Sipari≈ü silinirken bir hata olu≈ütu';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (e) {
                            console.error('Error response JSON parse hatasƒ±:', e);
                        }
                        console.error('Sipari≈ü silinirken hata:', errorMessage);
                        alert(`Hata: ${errorMessage}`);
                    }
                } catch (error) {
                    console.error('Sipari≈ü silinirken aƒü hatasƒ±:', error);
                    alert('Sipari≈ü silinirken bir aƒü hatasƒ± olu≈ütu.');
                }
            }
        }

        async function returnToPool(orderId) {
            if (confirm(`Sipari≈ü ID ${orderId}'i havuza atmak istediƒüinizden emin misiniz? Sipari≈ü tekrar "bekleniyor" durumuna ge√ßecek.`)) {
                try {
                    const response = await fetch(`${API_BASE}/api/admin/orders/${orderId}`, {
                        method: 'PATCH',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            status: 'bekleniyor',
                            kuryeid: null // Kurye atamasƒ±nƒ± kaldƒ±r
                        })
                    });

                    if (response.ok) {
                        console.log(`Sipari≈ü ${orderId} havuza atƒ±ldƒ±.`);
                        fetchOrders(); // Refresh the table
                    } else {
                        let errorMessage = 'Sipari≈ü havuza atƒ±lƒ±rken bir hata olu≈ütu';
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorMessage;
                        } catch (e) {
                            console.error('Error response JSON parse hatasƒ±:', e);
                        }
                        console.error('Sipari≈ü havuza atƒ±lƒ±rken hata:', errorMessage);
                        alert(`Hata: ${errorMessage}`);
                    }
                } catch (error) {
                    console.error('Sipari≈ü havuza atƒ±lƒ±rken aƒü hatasƒ±:', error);
                    alert('Sipari≈ü havuza atƒ±lƒ±rken bir aƒü hatasƒ± olu≈ütu.');
                }
            }
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function openImageModal(imageUrl) {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = imageUrl;
            imageModal.style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Status filter button functionality
        function filterByStatus(status) {
            // Update current status filter
            currentStatusFilter = status;
            
            // Update active button state
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Fetch orders with the new filter
            fetchOrders();
        }

        window.onclick = function(event) {
            const orderModal = document.getElementById('orderModal');
            const imageModal = document.getElementById('imageModal');
            
            if (event.target == orderModal) {
                orderModal.style.display = "none";
            }
            
            if (event.target == imageModal) {
                imageModal.style.display = "none";
            }
        }

        // Enhanced socket listeners for admin panel
        
        // Admin panel specific connection
        socket.on('connect', () => {
            console.log('üîó Admin orders page connected to socket');
            socket.emit('joinAdminRoom');
        });

        // Listen for real-time order updates from admin actions
        socket.on('adminOrderUpdate', (data) => {
            console.log('üìù Admin order update received:', data);
            
            if (data.action === 'updated') {
                // Refresh the table to show updated data
                fetchOrders();
            } else if (data.action === 'deleted') {
                // Remove order from table immediately
                const row = document.querySelector(`tr[data-order-id="${data.orderId}"]`);
                if (row) {
                    row.remove();
                }
                // Also refresh to update stats
                fetchOrders();
            }
        });

        // Listen for order cancellations
        socket.on('orderCancelled', (data) => {
            console.log('‚ùå Order cancelled:', data);
            fetchOrders(); // Refresh table
        });

        // Listen for order deliveries
        socket.on('orderDelivered', (data) => {
            console.log('üì¶ Order delivered:', data);
            fetchOrders(); // Refresh table
        });

        // Listen for order approvals
        socket.on('orderApproved', (data) => {
            console.log('‚úÖ Order approved:', data);
            fetchOrders(); // Refresh table
        });
    </script>
</body>
</html> 