<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸšš Kurye App - Restaurants</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .nav-link:hover { background: #5a67d8; }
        .nav-link.active { background: #4c51bf; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; color: #333; }
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
        }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 0.25rem;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .refresh-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #059669; }
        .actions { display: flex; gap: 0.5rem; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-weight: 600; color: #374151; }
        .form-group input, .form-group select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .delivery-area-form {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
        }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; color: #666; font-style: italic; }
        
        /* Map container */
        .map-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .left-panel {
            width: 100%;
        }
        .right-panel {
            width: 100%;
        }
        #map {
            height: 600px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .location-info {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        .location-badge {
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .location-none {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main-layout.js"></script>
    <!-- Google Maps API script will be loaded dynamically -->
</head>
<body>
    <div class="container">
        <!-- THE HEADER IS NOW DYNAMICALLY INSERTED HERE BY main-layout.js -->

        <div class="main-content">
            <div class="map-container">
                <div class="left-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸª Restoran Listesi</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadRestaurants()">ğŸ”„ Yenile</button>
                                <button class="btn btn-success" onclick="showAddRestaurantModal()">â• Restoran Ekle</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Restoran AdÄ±</th>
                                        <th>Email</th>
                                        <th>Åifre</th>
                                        <th>Phone</th>
                                        <th>Yetkili</th>
                                        <th>Konum</th>
                                        <th>Teslimat AlanlarÄ±</th>
                                        <th>Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="restaurantsTable">
                                    <tr><td colspan="8" class="loading">YÃ¼kleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Mahalle Ä°stekleri Section -->
                <div style="width: 100%; margin-top: 2rem;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“‹ Mahalle Ä°stekleri</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadNeighborhoodRequests()">ğŸ”„ Yenile</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Restoran</th>
                                        <th>Mahalle</th>
                                        <th>Restoran FiyatÄ±</th>
                                        <th>Kurye FiyatÄ±</th>
                                        <th>Durum</th>
                                        <th>Talep Tarihi</th>
                                        <th>Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="neighborhoodRequestsTable">
                                    <tr><td colspan="8" class="loading">YÃ¼kleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ—ºï¸ Restoran KonumlarÄ±</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadRestaurantMarkers()">ğŸ”„ Yenile</button>
                            </div>
                        </div>
                        <div id="map"></div>
                        <div class="location-info">
                            <p><strong>ğŸ“ KullanÄ±m:</strong> Haritada kÄ±rmÄ±zÄ± iÅŸaretler restoranlarÄ± gÃ¶sterir. Restoran seÃ§ip konum atamak iÃ§in iÅŸlemler bÃ¶lÃ¼mÃ¼ndeki "ğŸ“ Konum" butonunu kullanÄ±n.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Restaurant Modal -->
        <div id="restaurantModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRestaurantModal()">&times;</span>
                <h3 id="restaurantModalTitle">Restoran Ekle</h3>
                <form id="restaurantForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Restoran AdÄ±</label>
                            <input type="text" id="restaurantName" required>
                        </div>
                        <div class="form-group">
                            <label>Yetkili KiÅŸi</label>
                            <input type="text" id="restaurantYetkili" placeholder="Yetkili kiÅŸi adÄ±">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="addRestaurantPhone" placeholder="Phone Number" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="restaurantEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Åifre</label>
                            <input type="password" id="restaurantPassword" required>
                        </div>
                    </div>
                    
                    <!-- Konum SeÃ§me BÃ¶lÃ¼mÃ¼ -->
                    <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f8fafc;">
                        <h4 style="margin: 0 0 1rem 0; color: #374151;">ğŸ“ Restoran Konumu</h4>
                        <div id="currentLocationInfo" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; background: #fff;">
                            <p style="margin: 0; color: #666;">ğŸ—ºï¸ Konum belirtilmemiÅŸ</p>
                        </div>
                        <button type="button" class="btn btn-primary" id="selectLocationBtn" onclick="openLocationPickerFromModal()">
                            ğŸ“ Konum SeÃ§
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success" id="saveRestaurantBtn">ğŸ’¾ Kaydet</button>
                        <button type="button" class="btn btn-danger" onclick="closeRestaurantModal()">âŒ Ä°ptal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delivery Areas Management Modal -->
        <div id="deliveryAreasModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDeliveryAreasModal()">&times;</span>
                <h3 id="deliveryAreasModalTitle">Teslimat AlanlarÄ± YÃ¶netimi</h3>
                
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-success" onclick="showAddDeliveryAreaForm()">â• Yeni Alan Ekle</button>
                </div>

                <!-- Add New Delivery Area Form -->
                <div id="addDeliveryAreaForm" class="delivery-area-form" style="display: none;">
                    <h4>Yeni Teslimat AlanÄ± Ekle</h4>
                    <form id="deliveryAreaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Mahalle AdÄ±</label>
                                <input type="text" id="neighborhoodName" placeholder="Ã–rn: KadÄ±kÃ¶y, ÃœskÃ¼dar..." required>
                            </div>
                            <div class="form-group">
                                <label>Kurye Ãœcreti (â‚º)</label>
                                <input type="number" id="courierPrice" step="0.1" min="0" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>Restoran Ãœcreti (â‚º)</label>
                                <input type="number" id="deliveryPrice" step="0.1" min="0" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="isDeliveryAvailable" checked>
                                    Teslimat Aktif
                                </label>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-success">ğŸ’¾ Kaydet</button>
                            <button type="button" class="btn btn-danger" onclick="hideAddDeliveryAreaForm()">âŒ Ä°ptal</button>
                        </div>
                    </form>
                </div>

                <!-- Delivery Areas List -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mahalle</th>
                                <th>Restoran Ãœcreti</th>
                                <th>Kurye Ãœcreti</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="deliveryAreasTable">
                            <tr><td colspan="6" class="loading">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Edit Delivery Area Modal -->
        <div id="editDeliveryAreaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditDeliveryAreaModal()">&times;</span>
                <h3>Teslimat AlanÄ± DÃ¼zenle</h3>
                <form id="editDeliveryAreaForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mahalle AdÄ±</label>
                            <input type="text" id="editNeighborhoodName" required>
                        </div>
                        <div class="form-group">
                            <label>Restoran Ãœcreti (â‚º)</label>
                            <input type="number" id="editDeliveryPrice" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Kurye Ãœcreti (â‚º)</label>
                            <input type="number" id="editCourierPrice" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="editIsDeliveryAvailable">
                                Teslimat Aktif
                            </label>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success">ğŸ’¾ GÃ¼ncelle</button>
                        <button type="button" class="btn btn-danger" onclick="closeEditDeliveryAreaModal()">âŒ Ä°ptal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Location Picker Modal -->
        <div id="locationPickerModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeLocationPickerModal()">&times;</span>
                <h3 id="locationPickerTitle">ğŸ“ Restoran Konumu SeÃ§</h3>
                <div style="margin-bottom: 1rem;">
                    <p><strong>Adres Arama:</strong></p>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="addressSearch" placeholder="Adres yazÄ±n (Ã¶rn: KadÄ±kÃ¶y Ä°stanbul)" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        <button type="button" class="btn btn-primary" onclick="searchAddress()">ğŸ” Ara</button>
                    </div>
                </div>
                
                <div id="locationMap" style="height: 400px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;"></div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>SeÃ§ilen Konum:</strong></p>
                    <div id="selectedLocationInfo">
                        <p>ğŸ“ Haritadan bir nokta seÃ§in</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-success" onclick="saveRestaurantLocation()" id="saveLocationBtn" disabled>ğŸ’¾ Konumu Kaydet</button>
                    <button type="button" class="btn btn-danger" onclick="closeLocationPickerModal()">âŒ Ä°ptal</button>
                </div>
            </div>
        </div>

        <!-- Neighborhood Request Approval Modal -->
        <div id="approvalModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeApprovalModal()">&times;</span>
                <h3 id="approvalModalTitle">ğŸ“‹ Mahalle Talebini Onayla</h3>
                <div id="approvalRequestInfo" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <!-- Request info will be populated here -->
                </div>
                <form id="approvalForm">
                    <div class="form-group">
                        <label>Kurye FiyatÄ± (â‚º)</label>
                        <input type="number" id="approvalCourierPrice" step="0.1" min="0" placeholder="Kurye fiyatÄ±nÄ± girin" required>
                        <small style="color: #666;">
                            <span id="priceWarning">Kurye fiyatÄ± restoran fiyatÄ±ndan yÃ¼ksek olamaz.</span>
                            <br>
                            <span id="maxPriceInfo">Maksimum: â‚º0.00</span>
                        </small>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success" id="approveBtn">âœ… Onayla</button>
                        <button type="button" class="btn btn-danger" onclick="rejectNeighborhoodRequest(currentRequestId)">âŒ Reddet</button>
                        <button type="button" class="btn btn-danger" onclick="closeApprovalModal()">ğŸš« Ä°ptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // ğŸ” Admin ÅŸifre kontrolÃ¼
        function checkAdminAuth() {
            if (localStorage.getItem('adminAuth') !== 'authenticated') {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }
        
        // Sayfa yÃ¼klendiÄŸinde ÅŸifre kontrol et
        if (!checkAdminAuth()) {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: white; font-size: 1.2rem;">ğŸ” Yetki kontrolÃ¼ yapÄ±lÄ±yor...</div>';
        }

        let API_BASE; // Define API_BASE globally but without immediate assignment
        const socket = io();
        let currentRestaurantId = null;
        let currentEditAreaId = null;
        let currentEditingRestaurantId = null; // For editing restaurant
        let currentRequestId = null; // For neighborhood request approval
        let map, locationPickerMap;
        let restaurantMarkers = [];
        let selectedLocation = null;
        let locationPickerMarker = null;

        // Function to fetch API_BASE from backend
        async function fetchApiBase() {
            try {
                const response = await fetch('/api/admin/config/api-base-url');
                const data = await response.json();
                if (data.success && data.apiBaseUrl) {
                    API_BASE = data.apiBaseUrl;
                    console.log('API_BASE baÅŸarÄ±yla ayarlandÄ±:', API_BASE);
                } else {
                    console.error('API_BASE backend tarafÄ±ndan saÄŸlanamadÄ±:', data.message || 'Bilinmeyen Hata');
                    API_BASE = 'http://localhost:3000'; // Fallback to localhost
                }
            } catch (error) {
                console.error('API_BASE yÃ¼klenirken hata oluÅŸtu:', error);
                API_BASE = 'http://localhost:3000'; // Fallback to localhost on error
            }
        }

        // Google Maps API'sini dinamik olarak yÃ¼kle
        async function loadGoogleMapsScript() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/config/google-maps-key`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (data.success && data.key) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=geometry,places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                    console.log('Google Maps API script baÅŸarÄ±yla yÃ¼klendi.');
                } else {
                    console.error('Google Maps API anahtarÄ± backend tarafÄ±ndan saÄŸlanamadÄ±:', data.message || 'Bilinmeyen Hata');
                    // Fallback or error handling for map initialization
                    initMap(); // Attempt to initialize map even without key for basic functionality/error state
                }
            } catch (error) {
                console.error('Google Maps API script yÃ¼klenirken hata oluÅŸtu:', error);
                initMap(); // Attempt to initialize map even on script loading error
            }
        }

        // Helper function to get authorization headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return { 'Content-Type': 'application/json' };
        }

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', async function() {
            await fetchApiBase(); // Fetch API_BASE first
            loadRestaurants();
            loadNeighborhoodRequests(); // Load neighborhood requests
            loadGoogleMapsScript(); // Load Google Maps script dynamically after API_BASE is set
        });

        // RestoranlarÄ± yÃ¼kle
        function loadRestaurants() {
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayRestaurants(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Restoranlar yÃ¼klenirken hata:', error);
                    document.getElementById('restaurantsTable').innerHTML = 
                        '<tr><td colspan="8" style="color: red; text-align: center;">YÃ¼kleme hatasÄ±: ' + error.message + '</td></tr>';
                });
        }

        // RestoranlarÄ± gÃ¶ster
        function displayRestaurants(restaurants) {
            const tbody = document.getElementById('restaurantsTable');
            
            if (restaurants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Restoran bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = restaurants.map(restaurant => {
                console.log('DEBUG: restaurant.id before parseInt:', restaurant.id, typeof restaurant.id);
                return `
                <tr>
                    <td>${restaurant.id}</td>
                    <td>${restaurant.firma_adi}</td>
                    <td>${restaurant.email}</td>
                    <td>
                        <button class="btn" style="background: #667eea; color: white; padding: 3px 6px; font-size: 0.7rem;" onclick="showRestaurantPassword(${restaurant.id}, '${restaurant.password || 'Åifre yok'}')" title="Åifreyi GÃ¶ster">ğŸ‘ï¸</button>
                    </td>
                    <td>${restaurant.phone || 'Not specified'}</td>
                    <td>${restaurant.yetkili_name || '<span style="color: #999;">Not specified</span>'}</td>
                    <td>
                        ${restaurant.latitude && restaurant.longitude ? 
                            `<span class="location-badge">ğŸ“ ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</span>` :
                            `<span class="location-none">âŒ Konum Yok</span>`
                        }
                    </td>
                    <td>
                        <span style="background: #e0f2fe; color: #0277bd; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                            ${restaurant.delivery_areas_count} alan
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="manageDeliveryAreas(parseInt(${restaurant.id}), '${restaurant.firma_adi}')" title="Teslimat AlanlarÄ±">
                            ğŸšš Alan
                        </button>
                        <button class="btn btn-warning" onclick="editRestaurant(${restaurant.id})" title="DÃ¼zenle">
                            âœï¸
                        </button>
                        <button class="btn btn-danger" onclick="deleteRestaurant(${restaurant.id})" title="Sil">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>`
            }).join('');
        }

        // Teslimat alanlarÄ± yÃ¶netimi
        function manageDeliveryAreas(restaurantId, restaurantName) {
            currentRestaurantId = restaurantId;
            document.getElementById('deliveryAreasModalTitle').textContent = `Teslimat AlanlarÄ± - ${restaurantName}`;
            document.getElementById('deliveryAreasModal').style.display = 'block';
            loadDeliveryAreas(restaurantId);
        }

        // Teslimat alanlarÄ±nÄ± yÃ¼kle
        function loadDeliveryAreas(restaurantId) {
            console.log('Loading delivery areas for restaurant:', restaurantId);
            fetch(`${API_BASE}/api/admin/restaurants/${restaurantId}/neighborhoods`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received delivery areas data:', data);
                    if (data.success) {
                        displayDeliveryAreas(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Teslimat alanlarÄ± yÃ¼klenirken hata:', error);
                    document.getElementById('deliveryAreasTable').innerHTML = 
                        '<tr><td colspan="5" style="color: red; text-align: center;">YÃ¼kleme hatasÄ±: ' + error.message + '</td></tr>';
                });
        }

        // Teslimat alanlarÄ±nÄ± gÃ¶ster
        function displayDeliveryAreas(areas) {
            console.log('Displaying delivery areas:', areas);
            const tbody = document.getElementById('deliveryAreasTable');
            
            if (!areas || areas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Teslimat alanÄ± bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = areas.map(area => `
                <tr>
                    <td>${area.neighborhood_name}</td>
                    <td>â‚º${parseFloat(area.restaurant_price || 0).toFixed(2)}</td>
                    <td>â‚º${parseFloat(area.courier_price || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge ${area.is_delivery_available ? 'badge-active' : 'badge-inactive'} delivery-toggle-badge" 
                              data-area-id="${area.id}"
                              style="cursor: pointer; user-select: none; position: relative; z-index: 10; display: inline-block; padding: 0.25rem 0.5rem;" 
                              title="Teslimat durumunu deÄŸiÅŸtirmek iÃ§in tÄ±klayÄ±n">
                            ${area.is_delivery_available ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="editDeliveryArea(${area.id})" title="DÃ¼zenle">
                            âœï¸
                        </button>
                        <button class="btn btn-danger" onclick="deleteDeliveryArea(${area.id})" title="Sil">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>`
            ).join('');
            
            // Event delegation ile badge click'lerini handle et
            document.querySelectorAll('.delivery-toggle-badge').forEach(badge => {
                badge.addEventListener('click', function(e) {
                    console.log('Badge clicked - Event delegation working!');
                    e.stopPropagation();
                    e.preventDefault();
                    const areaId = this.getAttribute('data-area-id');
                    toggleDeliveryAvailability(parseInt(areaId), e);
                });
            });
        }

        // Yeni teslimat alanÄ± ekleme formu gÃ¶ster
        function showAddDeliveryAreaForm() {
            document.getElementById('addDeliveryAreaForm').style.display = 'block';
        }

        function hideAddDeliveryAreaForm() {
            document.getElementById('addDeliveryAreaForm').style.display = 'none';
            document.getElementById('deliveryAreaForm').reset();
        }

        // Teslimat alanÄ± ekleme form submit
        document.getElementById('deliveryAreaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                neighborhood_name: document.getElementById('neighborhoodName').value,
                restaurant_price: parseFloat(document.getElementById('deliveryPrice').value) || 0,
                courier_price: parseFloat(document.getElementById('courierPrice').value) || 0,
                is_delivery_available: document.getElementById('isDeliveryAvailable').checked
            };

            console.log('Submitting delivery area form:', formData);

            fetch(`${API_BASE}/api/admin/restaurants/${currentRestaurantId}/delivery-areas`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    alert(data.message || 'Teslimat alanÄ± baÅŸarÄ±yla eklendi');
                    hideAddDeliveryAreaForm();
                    loadDeliveryAreas(currentRestaurantId);
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Teslimat alanÄ± ekleme hatasÄ±:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        });

        // Teslimat durumunu toggle et
        function toggleDeliveryAvailability(areaId, event) {
            console.log('Toggling delivery availability for area:', areaId);
            
            // Event propagation'Ä± durdur
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${areaId}/toggle-availability`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Teslimat durumu gÃ¼ncellendi:', data.data);
                    // Teslimat alanlarÄ±nÄ± yenile
                    loadDeliveryAreas(currentRestaurantId);
                    
                    // BaÅŸarÄ± mesajÄ±nÄ± gÃ¶ster (isteÄŸe baÄŸlÄ±)
                    const message = data.message || 'Teslimat durumu gÃ¼ncellendi';
                    // KÄ±sa bir bildirim gÃ¶ster
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 0.75rem 1rem;
                        border-radius: 6px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        z-index: 9999;
                        font-size: 0.9rem;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Teslimat durumu gÃ¼ncellenirken hata:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        }

        // Teslimat alanÄ± dÃ¼zenle
        function editDeliveryArea(areaId) {
            console.log('Editing delivery area:', areaId);
            currentEditAreaId = areaId;
            
            // Ã–nce mevcut alanlarÄ± bul
            const rows = document.querySelectorAll('#deliveryAreasTable tr');
            let foundArea = null;
            
            rows.forEach(row => {
                const editBtn = row.querySelector(`button[onclick="editDeliveryArea(${areaId})"]`);
                if (editBtn) {
                    const cells = row.querySelectorAll('td');
                    foundArea = {
                        neighborhood_name: cells[0].textContent,
                        restaurant_price: parseFloat(cells[1].textContent.replace('â‚º', '')),
                        courier_price: parseFloat(cells[2].textContent.replace('â‚º', '')),
                        is_delivery_available: cells[3].querySelector('.badge-active') !== null
                    };
                }
            });
            
            if (foundArea) {
                document.getElementById('editNeighborhoodName').value = foundArea.neighborhood_name;
                document.getElementById('editDeliveryPrice').value = foundArea.restaurant_price;
                document.getElementById('editCourierPrice').value = foundArea.courier_price;
                document.getElementById('editIsDeliveryAvailable').checked = foundArea.is_delivery_available;
                document.getElementById('editDeliveryAreaModal').style.display = 'block';
            }
        }

        // Teslimat alanÄ± gÃ¼ncelleme form submit
        document.getElementById('editDeliveryAreaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                neighborhood_name: document.getElementById('editNeighborhoodName').value,
                restaurant_price: parseFloat(document.getElementById('editDeliveryPrice').value) || 0,
                courier_price: parseFloat(document.getElementById('editCourierPrice').value) || 0,
                is_delivery_available: document.getElementById('editIsDeliveryAvailable').checked
            };

            console.log('ğŸ”„ Form gÃ¼ncelleme verisi:', formData);
            console.log('ğŸ“ Checkbox durumu:', document.getElementById('editIsDeliveryAvailable').checked);
            console.log('ğŸ¯ GÃ¼ncellenen alan ID:', currentEditAreaId);

            fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${currentEditAreaId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Teslimat alanÄ± baÅŸarÄ±yla gÃ¼ncellendi');
                    closeEditDeliveryAreaModal();
                    loadDeliveryAreas(currentRestaurantId);
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Teslimat alanÄ± gÃ¼ncelleme hatasÄ±:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        });

        // Teslimat alanÄ± sil
        function deleteDeliveryArea(areaId) {
            if (confirm('Bu teslimat alanÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) {
                fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${areaId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'Teslimat alanÄ± baÅŸarÄ±yla silindi');
                        loadDeliveryAreas(currentRestaurantId);
                    } else {
                        alert(data.message || 'Hata oluÅŸtu');
                    }
                })
                .catch(error => {
                    console.error('Teslimat alanÄ± silme hatasÄ±:', error);
                    alert('Bir hata oluÅŸtu: ' + error.message);
                });
            }
        }

        // Harita baÅŸlatma
        function initMap() {
            // Ana harita
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: { lat: 41.0082, lng: 28.9784 }, // Ä°stanbul
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            loadRestaurantMarkers();
        }

        // Restoran markerlarÄ±nÄ± yÃ¼kle
        function loadRestaurantMarkers() {
            // Mevcut markerlarÄ± temizle
            restaurantMarkers.forEach(marker => marker.setMap(null));
            restaurantMarkers = [];
            
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const bounds = new google.maps.LatLngBounds();
                        let hasMarkers = false;
                        
                        data.data.forEach(restaurant => {
                            if (restaurant.latitude && restaurant.longitude) {
                                const position = { lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude) };
                                
                                const marker = new google.maps.Marker({
                                    position: position,
                                    map: map,
                                    title: restaurant.firma_adi,
                                    icon: {
                                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                                                <path fill="#e53e3e" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                                                <circle fill="#fff" cx="12" cy="9" r="2.5"/>
                                                <text x="12" y="10" text-anchor="middle" font-size="8" fill="#e53e3e">ğŸª</text>
                                            </svg>
                                        `)
                                    }
                                });
                                
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div style="padding: 0.5rem;">
                                            <h4 style="margin: 0 0 0.5rem 0; color: #333;">ğŸª ${restaurant.firma_adi}</h4>
                                            <p style="margin: 0; font-size: 0.9rem;">ğŸ“§ ${restaurant.email}</p>
                                            <p style="margin: 0; font-size: 0.9rem;">ğŸ“ ${restaurant.phone || 'Phone not specified'}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #666;">ğŸ“ ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</p>
                                        </div>
                                    `
                                });
                                
                                marker.addListener('click', () => {
                                    infoWindow.open(map, marker);
                                });
                                
                                restaurantMarkers.push(marker);
                                bounds.extend(position);
                                hasMarkers = true;
                            }
                        });
                        
                        // TÃ¼m markerlarÄ± kapsayacak ÅŸekilde haritayÄ± odakla
                        if (hasMarkers) {
                            map.fitBounds(bounds);
                            
                            // Minimum zoom seviyesi ayarla (Ã§ok fazla yakÄ±nlaÅŸtÄ±rmasÄ±n)
                            google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                                if (map.getZoom() > 15) {
                                    map.setZoom(15);
                                }
                            });
                        } else {
                            // HiÃ§ marker yoksa Ä°stanbul'u gÃ¶ster
                            map.setCenter({ lat: 41.0082, lng: 28.9784 });
                            map.setZoom(11);
                        }
                    }
                })
                .catch(error => {
                    console.error('Restoran konumlarÄ± yÃ¼klenirken hata:', error);
                });
        }

        // Konum seÃ§me modalÄ±nÄ± aÃ§
        function openLocationPicker(restaurantId, restaurantName) {
            currentRestaurantId = restaurantId;
            document.getElementById('locationPickerTitle').textContent = `ğŸ“ ${restaurantName} - Konum SeÃ§`;
            document.getElementById('locationPickerModal').style.display = 'block';
            
            // Location picker haritasÄ±nÄ± baÅŸlat
            setTimeout(() => {
                initLocationPickerMap();
            }, 100);
        }

        // Location picker haritasÄ±nÄ± baÅŸlat
        function initLocationPickerMap() {
            locationPickerMap = new google.maps.Map(document.getElementById('locationMap'), {
                zoom: 13,
                center: { lat: 41.0082, lng: 28.9784 }, // Ä°stanbul
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // Haritaya tÄ±klama eventi
            locationPickerMap.addListener('click', (event) => {
                selectLocation(event.latLng);
            });
            
            // Mevcut restoran konumunu gÃ¶ster (korunmalÄ± rota olduÄŸu iÃ§in token gerekir)
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const restaurant = data.data.find(r => r.id === currentRestaurantId);
                        if (restaurant && restaurant.latitude && restaurant.longitude) {
                            const existingLocation = { lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude) };
                            selectLocation(existingLocation);
                            locationPickerMap.setCenter(existingLocation);
                        }
                    }
                })
                .catch(error => {
                    console.error('Mevcut konum yÃ¼klenirken hata:', error);
                });
        }

        // Konum seÃ§
        function selectLocation(latLng) {
            selectedLocation = {
                lat: typeof latLng.lat === 'function' ? latLng.lat() : latLng.lat,
                lng: typeof latLng.lng === 'function' ? latLng.lng() : latLng.lng
            };
            
            // Mevcut marker'Ä± kaldÄ±r
            if (locationPickerMarker) {
                locationPickerMarker.setMap(null);
            }
            
            // Yeni marker ekle
            locationPickerMarker = new google.maps.Marker({
                position: selectedLocation,
                map: locationPickerMap,
                title: 'SeÃ§ilen Konum',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="#10b981" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                            <circle fill="#fff" cx="12" cy="9" r="2.5"/>
                        </svg>
                    `)
                }
            });
            
            // Konum bilgisini gÃ¶ster
            document.getElementById('selectedLocationInfo').innerHTML = `
                <p><strong>ğŸ“ SeÃ§ilen Konum:</strong></p>
                <p>Enlem: ${selectedLocation.lat.toFixed(6)}</p>
                <p>Boylam: ${selectedLocation.lng.toFixed(6)}</p>
            `;
            
            // Kaydet butonunu aktif et
            document.getElementById('saveLocationBtn').disabled = false;
        }

        // Adres ara
        function searchAddress() {
            const query = document.getElementById('addressSearch').value;
            if (!query) {
                alert('LÃ¼tfen bir adres girin');
                return;
            }
            
            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ address: query }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    locationPickerMap.setCenter(location);
                    locationPickerMap.setZoom(15);
                    selectLocation(location);
                } else {
                    alert('Adres bulunamadÄ±: ' + status);
                }
            });
        }

        // Restoran konumunu kaydet
        function saveRestaurantLocation() {
            if (!selectedLocation) {
                alert('LÃ¼tfen bir konum seÃ§in');
                return;
            }
            
            fetch(`${API_BASE}/api/admin/restaurants/${currentRestaurantId}/location`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    latitude: selectedLocation.lat,
                    longitude: selectedLocation.lng
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Konum baÅŸarÄ±yla kaydedildi');
                    
                    // EÄŸer edit modal aÃ§Ä±ksa konum bilgisini gÃ¼ncelle
                    if (document.getElementById('restaurantModal').style.display === 'block' && selectedLocation) {
                        // GÃ¼ncellenmiÅŸ restaurant verilerini simÃ¼le et
                        const updatedRestaurant = {
                            latitude: selectedLocation.lat,
                            longitude: selectedLocation.lng
                        };
                        updateCurrentLocationInfo(updatedRestaurant);
                    }
                    
                    closeLocationPickerModal();
                    loadRestaurants();
                    loadRestaurantMarkers();
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Konum kaydetme hatasÄ±:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        }

        // Location picker modalÄ±nÄ± kapat
        function closeLocationPickerModal() {
            document.getElementById('locationPickerModal').style.display = 'none';
            selectedLocation = null;
            if (locationPickerMarker) {
                locationPickerMarker.setMap(null);
                locationPickerMarker = null;
            }
            document.getElementById('selectedLocationInfo').innerHTML = '<p>ğŸ“ Haritadan bir nokta seÃ§in</p>';
            document.getElementById('saveLocationBtn').disabled = true;
            document.getElementById('addressSearch').value = '';
        }

        // Modal kapatma fonksiyonlarÄ±
        function closeDeliveryAreasModal() {
            document.getElementById('deliveryAreasModal').style.display = 'none';
            hideAddDeliveryAreaForm();
        }

        function closeEditDeliveryAreaModal() {
            document.getElementById('editDeliveryAreaModal').style.display = 'none';
            document.getElementById('editDeliveryAreaForm').reset();
        }

        function showAddRestaurantModal() {
            currentEditingRestaurantId = null;
            currentRestaurantId = null; // Yeni restoran iÃ§in konum yok
            document.getElementById('restaurantModalTitle').textContent = 'Restoran Ekle';
            document.getElementById('saveRestaurantBtn').textContent = 'ğŸ’¾ Kaydet';
            document.getElementById('restaurantForm').reset();
            
            // Åifre alanÄ±nÄ± zorunlu yap
            document.getElementById('restaurantPassword').required = true;
            document.getElementById('restaurantPassword').placeholder = '';
            
            // Konum bilgisini sÄ±fÄ±rla
            updateCurrentLocationInfo(null);
            
            document.getElementById('restaurantModal').style.display = 'block';
        }

        function showEditRestaurantModal(restaurantId, restaurant) {
            currentEditingRestaurantId = restaurantId;
            currentRestaurantId = restaurantId; // Konum iÃ§in de kullanÄ±lacak
            document.getElementById('restaurantModalTitle').textContent = 'Restoran DÃ¼zenle';
            document.getElementById('saveRestaurantBtn').textContent = 'ğŸ’¾ GÃ¼ncelle';
            
            // Form alanlarÄ±nÄ± doldur
            document.getElementById('restaurantName').value = restaurant.firma_adi;
            document.getElementById('restaurantYetkili').value = restaurant.yetkili_name || '';
            document.getElementById('addRestaurantPhone').value = restaurant.phone || '';
            document.getElementById('restaurantEmail').value = restaurant.email;
            document.getElementById('restaurantPassword').value = ''; // Åifre alanÄ±nÄ± boÅŸ bÄ±rak
            
            // Åifre alanÄ±nÄ± isteÄŸe baÄŸlÄ± yap
            document.getElementById('restaurantPassword').required = false;
            document.getElementById('restaurantPassword').placeholder = 'DeÄŸiÅŸtirmek istemiyorsanÄ±z boÅŸ bÄ±rakÄ±n';
            
            // Konum bilgisini gÃ¶ster
            updateCurrentLocationInfo(restaurant);
            
            document.getElementById('restaurantModal').style.display = 'block';
        }

        function closeRestaurantModal() {
            document.getElementById('restaurantModal').style.display = 'none';
            document.getElementById('restaurantForm').reset();
            currentEditingRestaurantId = null;
            currentRestaurantId = null;
            
            // Åifre alanÄ±nÄ± tekrar zorunlu yap (ekleme iÃ§in)
            document.getElementById('restaurantPassword').required = true;
            document.getElementById('restaurantPassword').placeholder = '';
            
            // Konum bilgisini sÄ±fÄ±rla
            updateCurrentLocationInfo(null);
        }

        // Konum bilgisini gÃ¼ncelle
        function updateCurrentLocationInfo(restaurant) {
            const currentLocationInfo = document.getElementById('currentLocationInfo');
            
            if (restaurant && restaurant.latitude && restaurant.longitude) {
                currentLocationInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="location-badge">ğŸ“ ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</span>
                        <span style="color: #10b981; font-weight: 500;">âœ… Konum kayÄ±tlÄ±</span>
                    </div>
                `;
            } else {
                currentLocationInfo.innerHTML = '<p style="margin: 0; color: #666;">ğŸ—ºï¸ Konum belirtilmemiÅŸ</p>';
            }
        }

        // Modal iÃ§inden konum seÃ§me
        function openLocationPickerFromModal() {
            if (!currentRestaurantId) {
                alert('âš ï¸ Ã–nce restoranÄ± kaydedin, sonra konum seÃ§ebilirsiniz.');
                return;
            }
            
            // Restoran adÄ±nÄ± modal title'dan al
            const restaurantName = document.getElementById('restaurantName').value || 'Restoran';
            
            openLocationPicker(currentRestaurantId, restaurantName);
        }

        // Restoran ekleme/dÃ¼zenleme form submit
        document.getElementById('restaurantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('restaurantName').value,
                yetkili_name: document.getElementById('restaurantYetkili').value,
                phone: document.getElementById('addRestaurantPhone').value,
                email: document.getElementById('restaurantEmail').value
            };

            console.log('ğŸ”„ Form data being sent:', formData);
            console.log('ğŸ”„ Current editing restaurant ID:', currentEditingRestaurantId);

            // Åifre sadece girilmiÅŸse ekle (dÃ¼zenleme sÄ±rasÄ±nda boÅŸ bÄ±rakÄ±labilir)
            const password = document.getElementById('restaurantPassword').value;
            if (password) {
                formData.password = password;
            }

            // DÃ¼zenleme mi ekleme mi?
            if (currentEditingRestaurantId) {
                // GÃ¼ncelleme iÅŸlemi
                fetch(`${API_BASE}/api/admin/restaurants/${currentEditingRestaurantId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Restoran baÅŸarÄ±yla gÃ¼ncellendi');
                        closeRestaurantModal();
                        loadRestaurants();
                    } else {
                        alert(data.message || 'Hata oluÅŸtu');
                    }
                })
                .catch(error => {
                    console.error('Restoran gÃ¼ncelleme hatasÄ±:', error);
                    alert('Bir hata oluÅŸtu: ' + error.message);
                });
            } else {
                // Ekleme iÅŸlemi
                if (!password) {
                    alert('Yeni restoran iÃ§in ÅŸifre gereklidir');
                    return;
                }
                
                fetch(`${API_BASE}/api/admin/restaurants`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Restoran baÅŸarÄ±yla eklendi');
                        closeRestaurantModal();
                        loadRestaurants();
                    } else {
                        alert(data.message || 'Hata oluÅŸtu');
                    }
                })
                .catch(error => {
                    console.error('Restoran ekleme hatasÄ±:', error);
                    alert('Bir hata oluÅŸtu: ' + error.message);
                });
            }
        });

        // Restoran dÃ¼zenle
        function editRestaurant(restaurantId) {
            // Mevcut restoran bilgilerini bul (admin rotasÄ± kullanÄ±lacak)
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const restaurant = data.data.find(r => r.id === restaurantId);
                        if (restaurant) {
                            showEditRestaurantModal(restaurantId, restaurant);
                        }
                    }
                })
                .catch(error => {
                    console.error('Restoran bilgileri alÄ±nÄ±rken hata:', error);
                    alert('Restoran bilgileri alÄ±namadÄ±: ' + error.message);
                });
        }

        // Restoran sil
        function deleteRestaurant(restaurantId) {
            if (confirm('Bu restoranÄ± silmek istediÄŸinizden emin misiniz?')) {
                // Not implemented yet (admin rotasÄ± kullanÄ±lacak)
                fetch(`${API_BASE}/api/admin/restaurants/${restaurantId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        alert(result.message || 'Restoran baÅŸarÄ±yla silindi');
                        loadRestaurants();
                    } else {
                        alert(result.message || 'Silme hatasÄ±');
                    }
                })
                .catch(error => {
                    console.error('Restoran silme hatasÄ±:', error);
                    alert('Bir hata oluÅŸtu: ' + error.message);
                });
            }
        }

        // Restoran ÅŸifresi gÃ¶ster
        function showRestaurantPassword(restaurantId, password) {
            alert(`Restoran #${restaurantId} ÅŸifresi:\n\n${password || 'Åifre bulunamadÄ±'}`);
        }

        // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma
        window.onclick = function(event) {
            const modals = ['deliveryAreasModal', 'editDeliveryAreaModal', 'restaurantModal', 'locationPickerModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'locationPickerModal') {
                        closeLocationPickerModal();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // =================== MAHALLe Ä°STEKLERÄ° YÃ–NETÄ°MÄ° ===================

        // Mahalle isteklerini yÃ¼kle
        function loadNeighborhoodRequests() {
            console.log('Loading neighborhood requests...');
            fetch(`${API_BASE}/api/admin/neighborhood-requests`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Neighborhood requests loaded:', data);
                    if (data.success) {
                        displayNeighborhoodRequests(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Mahalle istekleri yÃ¼klenirken hata:', error);
                    document.getElementById('neighborhoodRequestsTable').innerHTML = 
                        '<tr><td colspan="8" style="color: red; text-align: center;">YÃ¼kleme hatasÄ±: ' + error.message + '</td></tr>';
                });
        }

        // Mahalle isteklerini gÃ¶ster
        function displayNeighborhoodRequests(requests) {
            console.log('Displaying neighborhood requests:', requests);
            const tbody = document.getElementById('neighborhoodRequestsTable');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Mahalle isteÄŸi bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(request => {
                const statusBadge = getStatusBadge(request.status);
                const actionButtons = getActionButtons(request);
                
                return `
                <tr>
                    <td>${request.id}</td>
                    <td>${request.restaurant_name || 'Bilinmeyen'}</td>
                    <td>${request.neighborhood_name}</td>
                    <td>â‚º${parseFloat(request.restaurant_price || 0).toFixed(2)}</td>
                    <td>${request.courier_price ? 'â‚º' + parseFloat(request.courier_price).toFixed(2) : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(request.created_at).toLocaleDateString('tr-TR')}</td>
                    <td class="actions">${actionButtons}</td>
                </tr>`;
            }).join('');
        }

        // Durum badge'ini dÃ¶ndÃ¼r
        function getStatusBadge(status) {
            switch(status) {
                case 'pending':
                    return '<span class="badge" style="background: #fef3c7; color: #92400e;">â³ Beklemede</span>';
                case 'approved':
                    return '<span class="badge" style="background: #d1fae5; color: #065f46;">âœ… OnaylandÄ±</span>';
                case 'rejected':
                    return '<span class="badge" style="background: #fee2e2; color: #991b1b;">âŒ Reddedildi</span>';
                default:
                    return '<span class="badge" style="background: #f3f4f6; color: #374151;">â“ Bilinmiyor</span>';
            }
        }

        // Ä°ÅŸlem butonlarÄ±nÄ± dÃ¶ndÃ¼r
        function getActionButtons(request) {
            if (request.status === 'pending') {
                return `
                    <button class="btn btn-success" onclick="showApprovalModal(${request.id})" title="Onayla">
                        âœ… Onayla
                    </button>
                    <button class="btn btn-danger" onclick="rejectNeighborhoodRequest(${request.id})" title="Reddet">
                        âŒ Reddet
                    </button>
                `;
            } else {
                return `<span style="color: #666;">Ä°ÅŸlem yapÄ±ldÄ±</span>`;
            }
        }

        // Onaylama modal'Ä±nÄ± gÃ¶ster
        function showApprovalModal(requestId) {
            console.log('Showing approval modal for request:', requestId);
            currentRequestId = requestId;
            
            // Request'i bul
            fetch(`${API_BASE}/api/admin/neighborhood-requests`, {
                headers: getAuthHeaders()
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const request = data.data.find(r => r.id === requestId);
                        if (request) {
                            const restaurantPrice = parseFloat(request.restaurant_price || 0);
                            
                            document.getElementById('approvalRequestInfo').innerHTML = `
                                <h4>ğŸ“‹ Talep DetaylarÄ±</h4>
                                <p><strong>Restoran:</strong> ${request.restaurant_name || 'Bilinmeyen'}</p>
                                <p><strong>Mahalle:</strong> ${request.neighborhood_name}</p>
                                <p><strong>Restoran FiyatÄ±:</strong> <span style="color: #10b981; font-weight: bold;">â‚º${restaurantPrice.toFixed(2)}</span></p>
                                <p><strong>Talep Tarihi:</strong> ${new Date(request.created_at).toLocaleString('tr-TR')}</p>
                            `;
                            
                            // Kurye fiyatÄ±nÄ± temizle ve maksimum deÄŸeri ayarla
                            const courierPriceInput = document.getElementById('approvalCourierPrice');
                            courierPriceInput.value = '';
                            courierPriceInput.max = restaurantPrice; // Maksimum deÄŸeri ayarla
                            courierPriceInput.setAttribute('data-restaurant-price', restaurantPrice);
                            
                            // Maksimum fiyat bilgisini gÃ¼ncelle
                            document.getElementById('maxPriceInfo').textContent = `Maksimum: â‚º${restaurantPrice.toFixed(2)}`;
                            
                            // Real-time validation ekle
                            courierPriceInput.addEventListener('input', validateCourierPrice);
                            
                            // Modal'Ä± aÃ§
                            document.getElementById('approvalModal').style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Request detaylarÄ± alÄ±nÄ±rken hata:', error);
                    alert('Talep detaylarÄ± alÄ±namadÄ±: ' + error.message);
                });
        }

        // Kurye fiyatÄ± validasyonu
        function validateCourierPrice() {
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            const approveBtn = document.getElementById('approveBtn');
            const priceWarning = document.getElementById('priceWarning');
            
            const courierPrice = parseFloat(courierPriceInput.value);
            const restaurantPrice = parseFloat(courierPriceInput.getAttribute('data-restaurant-price'));
            
            if (courierPrice > restaurantPrice) {
                // Kurye fiyatÄ± Ã§ok yÃ¼ksek
                courierPriceInput.style.borderColor = '#ef4444';
                priceWarning.style.color = '#ef4444';
                priceWarning.textContent = 'âš ï¸ Kurye fiyatÄ± restoran fiyatÄ±ndan yÃ¼ksek olamaz!';
                approveBtn.disabled = true;
                approveBtn.style.opacity = '0.5';
            } else if (courierPrice <= 0) {
                // Kurye fiyatÄ± sÄ±fÄ±r veya negatif
                courierPriceInput.style.borderColor = '#ef4444';
                priceWarning.style.color = '#ef4444';
                priceWarning.textContent = 'âš ï¸ Kurye fiyatÄ± 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r!';
                approveBtn.disabled = true;
                approveBtn.style.opacity = '0.5';
            } else {
                // GeÃ§erli fiyat
                courierPriceInput.style.borderColor = '#10b981';
                priceWarning.style.color = '#10b981';
                priceWarning.textContent = 'âœ… Kurye fiyatÄ± uygun';
                approveBtn.disabled = false;
                approveBtn.style.opacity = '1';
            }
        }

        // Onaylama form submit
        document.getElementById('approvalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            const courierPrice = parseFloat(courierPriceInput.value);
            const restaurantPrice = parseFloat(courierPriceInput.getAttribute('data-restaurant-price'));
            
            // Validation kontrolÃ¼
            if (!courierPrice || courierPrice <= 0) {
                alert('âš ï¸ GeÃ§erli bir kurye fiyatÄ± girin!');
                return;
            }
            
            if (courierPrice > restaurantPrice) {
                alert(`âš ï¸ Kurye fiyatÄ± restoran fiyatÄ±ndan (â‚º${restaurantPrice.toFixed(2)}) yÃ¼ksek olamaz!`);
                return;
            }
            
            approveNeighborhoodRequest(currentRequestId, courierPrice);
        });

        // Mahalle talebini onayla
        function approveNeighborhoodRequest(requestId, courierPrice) {
            console.log('Approving neighborhood request:', requestId, 'with courier price:', courierPrice);
            
            fetch(`${API_BASE}/api/admin/neighborhood-requests/${requestId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    status: 'approved',
                    courier_price: courierPrice
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mahalle talebi baÅŸarÄ±yla onaylandÄ±! Teslimat alanlarÄ±na eklendi.');
                    closeApprovalModal();
                    loadNeighborhoodRequests();
                    loadRestaurants(); // Restoran listesini yenile (delivery_areas_count gÃ¼ncellenecek)
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Mahalle talebi onaylanÄ±rken hata:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        }

        // Mahalle talebini reddet
        function rejectNeighborhoodRequest(requestId) {
            if (!confirm('Bu mahalle talebini reddetmek istediÄŸinize emin misiniz?')) {
                return;
            }
            
            console.log('Rejecting neighborhood request:', requestId);
            
            fetch(`${API_BASE}/api/admin/neighborhood-requests/${requestId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    status: 'rejected',
                    courier_price: 0
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mahalle talebi reddedildi.');
                    closeApprovalModal();
                    loadNeighborhoodRequests();
                } else {
                    alert(data.message || 'Hata oluÅŸtu');
                }
            })
            .catch(error => {
                console.error('Mahalle talebi reddedilirken hata:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
            });
        }

        // Onaylama modal'Ä±nÄ± kapat
        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
            currentRequestId = null;
            
            // Input'u temizle ve stili sÄ±fÄ±rla
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            courierPriceInput.value = '';
            courierPriceInput.style.borderColor = '';
            courierPriceInput.removeAttribute('max');
            courierPriceInput.removeAttribute('data-restaurant-price');
            courierPriceInput.removeEventListener('input', validateCourierPrice);
            
            // Buton ve mesajlarÄ± sÄ±fÄ±rla
            const approveBtn = document.getElementById('approveBtn');
            approveBtn.disabled = false;
            approveBtn.style.opacity = '1';
            
            const priceWarning = document.getElementById('priceWarning');
            priceWarning.style.color = '#666';
            priceWarning.textContent = 'Kurye fiyatÄ± restoran fiyatÄ±ndan yÃ¼ksek olamaz.';
            
            document.getElementById('maxPriceInfo').textContent = 'Maksimum: â‚º0.00';
        }
    </script>
</body>
</html> 