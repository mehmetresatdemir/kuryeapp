<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Kurye App - Restaurants</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 2rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .nav-link:hover { background: #5a67d8; }
        .nav-link.active { background: #4c51bf; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; color: #333; }
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
        }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 0.25rem;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .refresh-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #059669; }
        .actions { display: flex; gap: 0.5rem; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-weight: 600; color: #374151; }
        .form-group input, .form-group select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .delivery-area-form {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
        }
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        .badge-active { background: #d1fae5; color: #065f46; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; color: #666; font-style: italic; }
        
        /* Map container */
        .map-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .left-panel {
            width: 100%;
        }
        .right-panel {
            width: 100%;
        }
        #map {
            height: 600px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .location-info {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #e5e7eb;
        }
        .location-badge {
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .location-none {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main-layout.js"></script>
    <!-- Google Maps API script will be loaded dynamically -->
</head>
<body>
    <div class="container">
        <!-- THE HEADER IS NOW DYNAMICALLY INSERTED HERE BY main-layout.js -->

        <div class="main-content">
            <div class="map-container">
                <div class="left-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üè™ Restoran Listesi</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadRestaurants()">üîÑ Yenile</button>
                                <button class="btn btn-success" onclick="showAddRestaurantModal()">‚ûï Restoran Ekle</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Restoran Adƒ±</th>
                                        <th>Email</th>
                                        <th>≈ûifre</th>
                                        <th>Phone</th>
                                        <th>Yetkili</th>
                                        <th>Konum</th>
                                        <th>Teslimat Alanlarƒ±</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="restaurantsTable">
                                    <tr><td colspan="8" class="loading">Y√ºkleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Mahalle ƒ∞stekleri Section -->
                <div style="width: 100%; margin-top: 2rem;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Mahalle ƒ∞stekleri</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadNeighborhoodRequests()">üîÑ Yenile</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Restoran</th>
                                        <th>Mahalle</th>
                                        <th>Restoran Fiyatƒ±</th>
                                        <th>Kurye Fiyatƒ±</th>
                                        <th>Durum</th>
                                        <th>Talep Tarihi</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="neighborhoodRequestsTable">
                                    <tr><td colspan="8" class="loading">Y√ºkleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üó∫Ô∏è Restoran Konumlarƒ±</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="refresh-btn" onclick="loadRestaurantMarkers()">üîÑ Yenile</button>
                            </div>
                        </div>
                        <div id="map"></div>
                        <div class="location-info">
                            <p><strong>üìç Kullanƒ±m:</strong> Haritada kƒ±rmƒ±zƒ± i≈üaretler restoranlarƒ± g√∂sterir. Restoran se√ßip konum atamak i√ßin i≈ülemler b√∂l√ºm√ºndeki "üìç Konum" butonunu kullanƒ±n.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Restaurant Modal -->
        <div id="restaurantModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRestaurantModal()">&times;</span>
                <h3 id="restaurantModalTitle">Restoran Ekle</h3>
                <form id="restaurantForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Restoran Adƒ±</label>
                            <input type="text" id="restaurantName" required>
                        </div>
                        <div class="form-group">
                            <label>Yetkili Ki≈üi</label>
                            <input type="text" id="restaurantYetkili" placeholder="Yetkili ki≈üi adƒ±">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="addRestaurantPhone" placeholder="Phone Number" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="restaurantEmail" required>
                        </div>
                        <div class="form-group">
                            <label>≈ûifre</label>
                            <input type="password" id="restaurantPassword" required>
                        </div>
                    </div>
                    
                    <!-- Konum Se√ßme B√∂l√ºm√º -->
                    <div style="margin-top: 1.5rem; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; background: #f8fafc;">
                        <h4 style="margin: 0 0 1rem 0; color: #374151;">üìç Restoran Konumu</h4>
                        <div id="currentLocationInfo" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; background: #fff;">
                            <p style="margin: 0; color: #666;">üó∫Ô∏è Konum belirtilmemi≈ü</p>
                        </div>
                        <button type="button" class="btn btn-primary" id="selectLocationBtn" onclick="openLocationPickerFromModal()">
                            üìç Konum Se√ß
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success" id="saveRestaurantBtn">üíæ Kaydet</button>
                        <button type="button" class="btn btn-danger" onclick="closeRestaurantModal()">‚ùå ƒ∞ptal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delivery Areas Management Modal -->
        <div id="deliveryAreasModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeDeliveryAreasModal()">&times;</span>
                <h3 id="deliveryAreasModalTitle">Teslimat Alanlarƒ± Y√∂netimi</h3>
                
                <div style="margin-bottom: 2rem;">
                    <button class="btn btn-success" onclick="showAddDeliveryAreaForm()">‚ûï Yeni Alan Ekle</button>
                </div>

                <!-- Add New Delivery Area Form -->
                <div id="addDeliveryAreaForm" class="delivery-area-form" style="display: none;">
                    <h4>Yeni Teslimat Alanƒ± Ekle</h4>
                    <form id="deliveryAreaForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Mahalle Adƒ±</label>
                                <input type="text" id="neighborhoodName" placeholder="√ñrn: Kadƒ±k√∂y, √úsk√ºdar..." required>
                            </div>
                            <div class="form-group">
                                <label>Kurye √úcreti (‚Ç∫)</label>
                                <input type="number" id="courierPrice" step="0.1" min="0" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>Restoran √úcreti (‚Ç∫)</label>
                                <input type="number" id="deliveryPrice" step="0.1" min="0" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="isDeliveryAvailable" checked>
                                    Teslimat Aktif
                                </label>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-success">üíæ Kaydet</button>
                            <button type="button" class="btn btn-danger" onclick="hideAddDeliveryAreaForm()">‚ùå ƒ∞ptal</button>
                        </div>
                    </form>
                </div>

                <!-- Delivery Areas List -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Mahalle</th>
                                <th>Restoran √úcreti</th>
                                <th>Kurye √úcreti</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="deliveryAreasTable">
                            <tr><td colspan="6" class="loading">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Edit Delivery Area Modal -->
        <div id="editDeliveryAreaModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeEditDeliveryAreaModal()">&times;</span>
                <h3>Teslimat Alanƒ± D√ºzenle</h3>
                <form id="editDeliveryAreaForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mahalle Adƒ±</label>
                            <input type="text" id="editNeighborhoodName" required>
                        </div>
                        <div class="form-group">
                            <label>Restoran √úcreti (‚Ç∫)</label>
                            <input type="number" id="editDeliveryPrice" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Kurye √úcreti (‚Ç∫)</label>
                            <input type="number" id="editCourierPrice" step="0.1" min="0" required>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="editIsDeliveryAvailable">
                                Teslimat Aktif
                            </label>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success">üíæ G√ºncelle</button>
                        <button type="button" class="btn btn-danger" onclick="closeEditDeliveryAreaModal()">‚ùå ƒ∞ptal</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Location Picker Modal -->
        <div id="locationPickerModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeLocationPickerModal()">&times;</span>
                <h3 id="locationPickerTitle">üìç Restoran Konumu Se√ß</h3>
                <div style="margin-bottom: 1rem;">
                    <p><strong>Adres Arama:</strong></p>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input type="text" id="addressSearch" placeholder="Adres yazƒ±n (√∂rn: Kadƒ±k√∂y ƒ∞stanbul)" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        <button type="button" class="btn btn-primary" onclick="searchAddress()">üîç Ara</button>
                    </div>
                </div>
                
                <div id="locationMap" style="height: 400px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;"></div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p><strong>Se√ßilen Konum:</strong></p>
                    <div id="selectedLocationInfo">
                        <p>üìç Haritadan bir nokta se√ßin</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-success" onclick="saveRestaurantLocation()" id="saveLocationBtn" disabled>üíæ Konumu Kaydet</button>
                    <button type="button" class="btn btn-danger" onclick="closeLocationPickerModal()">‚ùå ƒ∞ptal</button>
                </div>
            </div>
        </div>

        <!-- Neighborhood Request Approval Modal -->
        <div id="approvalModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeApprovalModal()">&times;</span>
                <h3 id="approvalModalTitle">üìã Mahalle Talebini Onayla</h3>
                <div id="approvalRequestInfo" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <!-- Request info will be populated here -->
                </div>
                <form id="approvalForm">
                    <div class="form-group">
                        <label>Kurye Fiyatƒ± (‚Ç∫)</label>
                        <input type="number" id="approvalCourierPrice" step="0.1" min="0" placeholder="Kurye fiyatƒ±nƒ± girin" required>
                        <small style="color: #666;">
                            <span id="priceWarning">Kurye fiyatƒ± restoran fiyatƒ±ndan y√ºksek olamaz.</span>
                            <br>
                            <span id="maxPriceInfo">Maksimum: ‚Ç∫0.00</span>
                        </small>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-success" id="approveBtn">‚úÖ Onayla</button>
                        <button type="button" class="btn btn-danger" onclick="rejectNeighborhoodRequest(currentRequestId)">‚ùå Reddet</button>
                        <button type="button" class="btn btn-danger" onclick="closeApprovalModal()">üö´ ƒ∞ptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // üîê Admin ≈üifre kontrol√º
        function checkAdminAuth() {
            if (localStorage.getItem('adminAuth') !== 'authenticated') {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }
        
        // Sayfa y√ºklendiƒüinde ≈üifre kontrol et
        if (!checkAdminAuth()) {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: white; font-size: 1.2rem;">üîê Yetki kontrol√º yapƒ±lƒ±yor...</div>';
        }

        let API_BASE; // Define API_BASE globally but without immediate assignment
        const socket = io();
        let currentRestaurantId = null;
        let currentEditAreaId = null;
        let currentEditingRestaurantId = null; // For editing restaurant
        let currentRequestId = null; // For neighborhood request approval
        let map, locationPickerMap;
        let restaurantMarkers = [];
        let selectedLocation = null;
        let locationPickerMarker = null;

        // Function to fetch API_BASE from backend
        async function fetchApiBase() {
            try {
                const response = await fetch('/api/admin/config/api-base-url');
                const data = await response.json();
                if (data.success && data.apiBaseUrl) {
                    API_BASE = data.apiBaseUrl;
                    console.log('API_BASE ba≈üarƒ±yla ayarlandƒ±:', API_BASE);
                } else {
                    console.error('API_BASE backend tarafƒ±ndan saƒülanamadƒ±:', data.message || 'Bilinmeyen Hata');
                    API_BASE = 'http://localhost:3000'; // Fallback to localhost
                }
            } catch (error) {
                console.error('API_BASE y√ºklenirken hata olu≈ütu:', error);
                API_BASE = 'http://localhost:3000'; // Fallback to localhost on error
            }
        }

        // Google Maps API'sini dinamik olarak y√ºkle
        async function loadGoogleMapsScript() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/config/google-maps-key`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (data.success && data.key) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=geometry,places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                    console.log('Google Maps API script ba≈üarƒ±yla y√ºklendi.');
                } else {
                    console.error('Google Maps API anahtarƒ± backend tarafƒ±ndan saƒülanamadƒ±:', data.message || 'Bilinmeyen Hata');
                    // Fallback or error handling for map initialization
                    initMap(); // Attempt to initialize map even without key for basic functionality/error state
                }
            } catch (error) {
                console.error('Google Maps API script y√ºklenirken hata olu≈ütu:', error);
                initMap(); // Attempt to initialize map even on script loading error
            }
        }

        // Helper function to get authorization headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return { 'Content-Type': 'application/json' };
        }

        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', async function() {
            await fetchApiBase(); // Fetch API_BASE first
            loadRestaurants();
            loadNeighborhoodRequests(); // Load neighborhood requests
            loadGoogleMapsScript(); // Load Google Maps script dynamically after API_BASE is set
        });

        // Restoranlarƒ± y√ºkle
        function loadRestaurants() {
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        displayRestaurants(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Restoranlar y√ºklenirken hata:', error);
                    document.getElementById('restaurantsTable').innerHTML = 
                        '<tr><td colspan="8" style="color: red; text-align: center;">Y√ºkleme hatasƒ±: ' + error.message + '</td></tr>';
                });
        }

        // Restoranlarƒ± g√∂ster
        function displayRestaurants(restaurants) {
            const tbody = document.getElementById('restaurantsTable');
            
            if (restaurants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Restoran bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = restaurants.map(restaurant => {
                console.log('DEBUG: restaurant.id before parseInt:', restaurant.id, typeof restaurant.id);
                return `
                <tr>
                    <td>${restaurant.id}</td>
                    <td>${restaurant.firma_adi}</td>
                    <td>${restaurant.email}</td>
                    <td>
                        <button class="btn" style="background: #667eea; color: white; padding: 3px 6px; font-size: 0.7rem;" onclick="showRestaurantPassword(${restaurant.id}, '${restaurant.password || '≈ûifre yok'}')" title="≈ûifreyi G√∂ster">üëÅÔ∏è</button>
                    </td>
                    <td>${restaurant.phone || 'Not specified'}</td>
                    <td>${restaurant.yetkili_name || '<span style="color: #999;">Not specified</span>'}</td>
                    <td>
                        ${restaurant.latitude && restaurant.longitude ? 
                            `<span class="location-badge">üìç ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</span>` :
                            `<span class="location-none">‚ùå Konum Yok</span>`
                        }
                    </td>
                    <td>
                        <span style="background: #e0f2fe; color: #0277bd; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                            ${restaurant.delivery_areas_count} alan
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-primary" onclick="manageDeliveryAreas(parseInt(${restaurant.id}), '${restaurant.firma_adi}')" title="Teslimat Alanlarƒ±">
                            üöö Alan
                        </button>
                        <button class="btn btn-warning" onclick="editRestaurant(${restaurant.id})" title="D√ºzenle">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger" onclick="deleteRestaurant(${restaurant.id})" title="Sil">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>`
            }).join('');
        }

        // Teslimat alanlarƒ± y√∂netimi
        function manageDeliveryAreas(restaurantId, restaurantName) {
            currentRestaurantId = restaurantId;
            document.getElementById('deliveryAreasModalTitle').textContent = `Teslimat Alanlarƒ± - ${restaurantName}`;
            document.getElementById('deliveryAreasModal').style.display = 'block';
            loadDeliveryAreas(restaurantId);
        }

        // Teslimat alanlarƒ±nƒ± y√ºkle
        function loadDeliveryAreas(restaurantId) {
            console.log('Loading delivery areas for restaurant:', restaurantId);
            fetch(`${API_BASE}/api/admin/restaurants/${restaurantId}/neighborhoods`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received delivery areas data:', data);
                    if (data.success) {
                        displayDeliveryAreas(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Teslimat alanlarƒ± y√ºklenirken hata:', error);
                    document.getElementById('deliveryAreasTable').innerHTML = 
                        '<tr><td colspan="5" style="color: red; text-align: center;">Y√ºkleme hatasƒ±: ' + error.message + '</td></tr>';
                });
        }

        // Teslimat alanlarƒ±nƒ± g√∂ster
        function displayDeliveryAreas(areas) {
            console.log('Displaying delivery areas:', areas);
            const tbody = document.getElementById('deliveryAreasTable');
            
            if (!areas || areas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Teslimat alanƒ± bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = areas.map(area => `
                <tr>
                    <td>${area.neighborhood_name}</td>
                    <td>‚Ç∫${parseFloat(area.restaurant_price || 0).toFixed(2)}</td>
                    <td>‚Ç∫${parseFloat(area.courier_price || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge ${area.is_delivery_available ? 'badge-active' : 'badge-inactive'} delivery-toggle-badge" 
                              data-area-id="${area.id}"
                              style="cursor: pointer; user-select: none; position: relative; z-index: 10; display: inline-block; padding: 0.25rem 0.5rem;" 
                              title="Teslimat durumunu deƒüi≈ütirmek i√ßin tƒ±klayƒ±n">
                            ${area.is_delivery_available ? 'Aktif' : 'Pasif'}
                        </span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-warning" onclick="editDeliveryArea(${area.id})" title="D√ºzenle">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-danger" onclick="deleteDeliveryArea(${area.id})" title="Sil">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>`
            ).join('');
            
            // Event delegation ile badge click'lerini handle et
            document.querySelectorAll('.delivery-toggle-badge').forEach(badge => {
                badge.addEventListener('click', function(e) {
                    console.log('Badge clicked - Event delegation working!');
                    e.stopPropagation();
                    e.preventDefault();
                    const areaId = this.getAttribute('data-area-id');
                    toggleDeliveryAvailability(parseInt(areaId), e);
                });
            });
        }

        // Yeni teslimat alanƒ± ekleme formu g√∂ster
        function showAddDeliveryAreaForm() {
            document.getElementById('addDeliveryAreaForm').style.display = 'block';
        }

        function hideAddDeliveryAreaForm() {
            document.getElementById('addDeliveryAreaForm').style.display = 'none';
            document.getElementById('deliveryAreaForm').reset();
        }

        // Teslimat alanƒ± ekleme form submit
        document.getElementById('deliveryAreaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                neighborhood_name: document.getElementById('neighborhoodName').value,
                restaurant_price: parseFloat(document.getElementById('deliveryPrice').value) || 0,
                courier_price: parseFloat(document.getElementById('courierPrice').value) || 0,
                is_delivery_available: document.getElementById('isDeliveryAvailable').checked
            };

            console.log('Submitting delivery area form:', formData);

            fetch(`${API_BASE}/api/admin/restaurants/${currentRestaurantId}/delivery-areas`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.success) {
                    alert(data.message || 'Teslimat alanƒ± ba≈üarƒ±yla eklendi');
                    hideAddDeliveryAreaForm();
                    loadDeliveryAreas(currentRestaurantId);
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Teslimat alanƒ± ekleme hatasƒ±:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        });

        // Teslimat durumunu toggle et
        function toggleDeliveryAvailability(areaId, event) {
            console.log('Toggling delivery availability for area:', areaId);
            
            // Event propagation'ƒ± durdur
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${areaId}/toggle-availability`, {
                method: 'PATCH',
                headers: getAuthHeaders()
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Teslimat durumu g√ºncellendi:', data.data);
                    // Teslimat alanlarƒ±nƒ± yenile
                    loadDeliveryAreas(currentRestaurantId);
                    
                    // Ba≈üarƒ± mesajƒ±nƒ± g√∂ster (isteƒüe baƒülƒ±)
                    const message = data.message || 'Teslimat durumu g√ºncellendi';
                    // Kƒ±sa bir bildirim g√∂ster
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 0.75rem 1rem;
                        border-radius: 6px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        z-index: 9999;
                        font-size: 0.9rem;
                    `;
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Teslimat durumu g√ºncellenirken hata:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Teslimat alanƒ± d√ºzenle
        function editDeliveryArea(areaId) {
            console.log('Editing delivery area:', areaId);
            currentEditAreaId = areaId;
            
            // √ñnce mevcut alanlarƒ± bul
            const rows = document.querySelectorAll('#deliveryAreasTable tr');
            let foundArea = null;
            
            rows.forEach(row => {
                const editBtn = row.querySelector(`button[onclick="editDeliveryArea(${areaId})"]`);
                if (editBtn) {
                    const cells = row.querySelectorAll('td');
                    foundArea = {
                        neighborhood_name: cells[0].textContent,
                        restaurant_price: parseFloat(cells[1].textContent.replace('‚Ç∫', '')),
                        courier_price: parseFloat(cells[2].textContent.replace('‚Ç∫', '')),
                        is_delivery_available: cells[3].querySelector('.badge-active') !== null
                    };
                }
            });
            
            if (foundArea) {
                document.getElementById('editNeighborhoodName').value = foundArea.neighborhood_name;
                document.getElementById('editDeliveryPrice').value = foundArea.restaurant_price;
                document.getElementById('editCourierPrice').value = foundArea.courier_price;
                document.getElementById('editIsDeliveryAvailable').checked = foundArea.is_delivery_available;
                document.getElementById('editDeliveryAreaModal').style.display = 'block';
            }
        }

        // Teslimat alanƒ± g√ºncelleme form submit
        document.getElementById('editDeliveryAreaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                neighborhood_name: document.getElementById('editNeighborhoodName').value,
                restaurant_price: parseFloat(document.getElementById('editDeliveryPrice').value) || 0,
                courier_price: parseFloat(document.getElementById('editCourierPrice').value) || 0,
                is_delivery_available: document.getElementById('editIsDeliveryAvailable').checked
            };

            console.log('üîÑ Form g√ºncelleme verisi:', formData);
            console.log('üìù Checkbox durumu:', document.getElementById('editIsDeliveryAvailable').checked);
            console.log('üéØ G√ºncellenen alan ID:', currentEditAreaId);

            fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${currentEditAreaId}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert(data.message || 'Teslimat alanƒ± ba≈üarƒ±yla g√ºncellendi');
                    closeEditDeliveryAreaModal();
                    loadDeliveryAreas(currentRestaurantId);
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Teslimat alanƒ± g√ºncelleme hatasƒ±:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        });

        // Teslimat alanƒ± sil
        function deleteDeliveryArea(areaId) {
            if (confirm('Bu teslimat alanƒ±nƒ± silmek istediƒüinizden emin misiniz?')) {
                fetch(`${API_BASE}/api/admin/restaurants/delivery-areas/${areaId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message || 'Teslimat alanƒ± ba≈üarƒ±yla silindi');
                        loadDeliveryAreas(currentRestaurantId);
                    } else {
                        alert(data.message || 'Hata olu≈ütu');
                    }
                })
                .catch(error => {
                    console.error('Teslimat alanƒ± silme hatasƒ±:', error);
                    alert('Bir hata olu≈ütu: ' + error.message);
                });
            }
        }

        // Harita ba≈ülatma
        function initMap() {
            // Ana harita
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 11,
                center: { lat: 41.0082, lng: 28.9784 }, // ƒ∞stanbul
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            loadRestaurantMarkers();
        }

        // Restoran markerlarƒ±nƒ± y√ºkle
        function loadRestaurantMarkers() {
            // Mevcut markerlarƒ± temizle
            restaurantMarkers.forEach(marker => marker.setMap(null));
            restaurantMarkers = [];
            
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const bounds = new google.maps.LatLngBounds();
                        let hasMarkers = false;
                        
                        data.data.forEach(restaurant => {
                            if (restaurant.latitude && restaurant.longitude) {
                                const position = { lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude) };
                                
                                const marker = new google.maps.Marker({
                                    position: position,
                                    map: map,
                                    title: restaurant.firma_adi,
                                    icon: {
                                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                                                <path fill="#e53e3e" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                                                <circle fill="#fff" cx="12" cy="9" r="2.5"/>
                                                <text x="12" y="10" text-anchor="middle" font-size="8" fill="#e53e3e">üè™</text>
                                            </svg>
                                        `)
                                    }
                                });
                                
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div style="padding: 0.5rem;">
                                            <h4 style="margin: 0 0 0.5rem 0; color: #333;">üè™ ${restaurant.firma_adi}</h4>
                                            <p style="margin: 0; font-size: 0.9rem;">üìß ${restaurant.email}</p>
                                            <p style="margin: 0; font-size: 0.9rem;">üìû ${restaurant.phone || 'Phone not specified'}</p>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #666;">üìç ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</p>
                                        </div>
                                    `
                                });
                                
                                marker.addListener('click', () => {
                                    infoWindow.open(map, marker);
                                });
                                
                                restaurantMarkers.push(marker);
                                bounds.extend(position);
                                hasMarkers = true;
                            }
                        });
                        
                        // T√ºm markerlarƒ± kapsayacak ≈üekilde haritayƒ± odakla
                        if (hasMarkers) {
                            map.fitBounds(bounds);
                            
                            // Minimum zoom seviyesi ayarla (√ßok fazla yakƒ±nla≈ütƒ±rmasƒ±n)
                            google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                                if (map.getZoom() > 15) {
                                    map.setZoom(15);
                                }
                            });
                        } else {
                            // Hi√ß marker yoksa ƒ∞stanbul'u g√∂ster
                            map.setCenter({ lat: 41.0082, lng: 28.9784 });
                            map.setZoom(11);
                        }
                    }
                })
                .catch(error => {
                    console.error('Restoran konumlarƒ± y√ºklenirken hata:', error);
                });
        }

        // Konum se√ßme modalƒ±nƒ± a√ß
        function openLocationPicker(restaurantId, restaurantName) {
            currentRestaurantId = restaurantId;
            document.getElementById('locationPickerTitle').textContent = `üìç ${restaurantName} - Konum Se√ß`;
            document.getElementById('locationPickerModal').style.display = 'block';
            
            // Location picker haritasƒ±nƒ± ba≈ülat
            setTimeout(() => {
                initLocationPickerMap();
            }, 100);
        }

        // Location picker haritasƒ±nƒ± ba≈ülat
        function initLocationPickerMap() {
            locationPickerMap = new google.maps.Map(document.getElementById('locationMap'), {
                zoom: 13,
                center: { lat: 41.0082, lng: 28.9784 }, // ƒ∞stanbul
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // Haritaya tƒ±klama eventi
            locationPickerMap.addListener('click', (event) => {
                selectLocation(event.latLng);
            });
            
            // Mevcut restoran konumunu g√∂ster (korunmalƒ± rota olduƒüu i√ßin token gerekir)
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const restaurant = data.data.find(r => r.id === currentRestaurantId);
                        if (restaurant && restaurant.latitude && restaurant.longitude) {
                            const existingLocation = { lat: parseFloat(restaurant.latitude), lng: parseFloat(restaurant.longitude) };
                            selectLocation(existingLocation);
                            locationPickerMap.setCenter(existingLocation);
                        }
                    }
                })
                .catch(error => {
                    console.error('Mevcut konum y√ºklenirken hata:', error);
                });
        }

        // Konum se√ß
        function selectLocation(latLng) {
            selectedLocation = {
                lat: typeof latLng.lat === 'function' ? latLng.lat() : latLng.lat,
                lng: typeof latLng.lng === 'function' ? latLng.lng() : latLng.lng
            };
            
            // Mevcut marker'ƒ± kaldƒ±r
            if (locationPickerMarker) {
                locationPickerMarker.setMap(null);
            }
            
            // Yeni marker ekle
            locationPickerMarker = new google.maps.Marker({
                position: selectedLocation,
                map: locationPickerMap,
                title: 'Se√ßilen Konum',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
                            <path fill="#10b981" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
                            <circle fill="#fff" cx="12" cy="9" r="2.5"/>
                        </svg>
                    `)
                }
            });
            
            // Konum bilgisini g√∂ster
            document.getElementById('selectedLocationInfo').innerHTML = `
                <p><strong>üìç Se√ßilen Konum:</strong></p>
                <p>Enlem: ${selectedLocation.lat.toFixed(6)}</p>
                <p>Boylam: ${selectedLocation.lng.toFixed(6)}</p>
            `;
            
            // Kaydet butonunu aktif et
            document.getElementById('saveLocationBtn').disabled = false;
        }

        // Adres ara
        function searchAddress() {
            const query = document.getElementById('addressSearch').value;
            if (!query) {
                alert('L√ºtfen bir adres girin');
                return;
            }
            
            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ address: query }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    locationPickerMap.setCenter(location);
                    locationPickerMap.setZoom(15);
                    selectLocation(location);
                } else {
                    alert('Adres bulunamadƒ±: ' + status);
                }
            });
        }

        // Restoran konumunu kaydet
        function saveRestaurantLocation() {
            if (!selectedLocation) {
                alert('L√ºtfen bir konum se√ßin');
                return;
            }
            
            fetch(`${API_BASE}/api/admin/restaurants/${currentRestaurantId}/location`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    latitude: selectedLocation.lat,
                    longitude: selectedLocation.lng
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Konum ba≈üarƒ±yla kaydedildi');
                    
                    // Eƒüer edit modal a√ßƒ±ksa konum bilgisini g√ºncelle
                    if (document.getElementById('restaurantModal').style.display === 'block' && selectedLocation) {
                        // G√ºncellenmi≈ü restaurant verilerini sim√ºle et
                        const updatedRestaurant = {
                            latitude: selectedLocation.lat,
                            longitude: selectedLocation.lng
                        };
                        updateCurrentLocationInfo(updatedRestaurant);
                    }
                    
                    closeLocationPickerModal();
                    loadRestaurants();
                    loadRestaurantMarkers();
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Konum kaydetme hatasƒ±:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Location picker modalƒ±nƒ± kapat
        function closeLocationPickerModal() {
            document.getElementById('locationPickerModal').style.display = 'none';
            selectedLocation = null;
            if (locationPickerMarker) {
                locationPickerMarker.setMap(null);
                locationPickerMarker = null;
            }
            document.getElementById('selectedLocationInfo').innerHTML = '<p>üìç Haritadan bir nokta se√ßin</p>';
            document.getElementById('saveLocationBtn').disabled = true;
            document.getElementById('addressSearch').value = '';
        }

        // Modal kapatma fonksiyonlarƒ±
        function closeDeliveryAreasModal() {
            document.getElementById('deliveryAreasModal').style.display = 'none';
            hideAddDeliveryAreaForm();
        }

        function closeEditDeliveryAreaModal() {
            document.getElementById('editDeliveryAreaModal').style.display = 'none';
            document.getElementById('editDeliveryAreaForm').reset();
        }

        function showAddRestaurantModal() {
            currentEditingRestaurantId = null;
            currentRestaurantId = null; // Yeni restoran i√ßin konum yok
            document.getElementById('restaurantModalTitle').textContent = 'Restoran Ekle';
            document.getElementById('saveRestaurantBtn').textContent = 'üíæ Kaydet';
            document.getElementById('restaurantForm').reset();
            
            // ≈ûifre alanƒ±nƒ± zorunlu yap
            document.getElementById('restaurantPassword').required = true;
            document.getElementById('restaurantPassword').placeholder = '';
            
            // Konum bilgisini sƒ±fƒ±rla
            updateCurrentLocationInfo(null);
            
            document.getElementById('restaurantModal').style.display = 'block';
        }

        function showEditRestaurantModal(restaurantId, restaurant) {
            currentEditingRestaurantId = restaurantId;
            currentRestaurantId = restaurantId; // Konum i√ßin de kullanƒ±lacak
            document.getElementById('restaurantModalTitle').textContent = 'Restoran D√ºzenle';
            document.getElementById('saveRestaurantBtn').textContent = 'üíæ G√ºncelle';
            
            // Form alanlarƒ±nƒ± doldur
            document.getElementById('restaurantName').value = restaurant.firma_adi;
            document.getElementById('restaurantYetkili').value = restaurant.yetkili_name || '';
            document.getElementById('addRestaurantPhone').value = restaurant.phone || '';
            document.getElementById('restaurantEmail').value = restaurant.email;
            document.getElementById('restaurantPassword').value = ''; // ≈ûifre alanƒ±nƒ± bo≈ü bƒ±rak
            
            // ≈ûifre alanƒ±nƒ± isteƒüe baƒülƒ± yap
            document.getElementById('restaurantPassword').required = false;
            document.getElementById('restaurantPassword').placeholder = 'Deƒüi≈ütirmek istemiyorsanƒ±z bo≈ü bƒ±rakƒ±n';
            
            // Konum bilgisini g√∂ster
            updateCurrentLocationInfo(restaurant);
            
            document.getElementById('restaurantModal').style.display = 'block';
        }

        function closeRestaurantModal() {
            document.getElementById('restaurantModal').style.display = 'none';
            document.getElementById('restaurantForm').reset();
            currentEditingRestaurantId = null;
            currentRestaurantId = null;
            
            // ≈ûifre alanƒ±nƒ± tekrar zorunlu yap (ekleme i√ßin)
            document.getElementById('restaurantPassword').required = true;
            document.getElementById('restaurantPassword').placeholder = '';
            
            // Konum bilgisini sƒ±fƒ±rla
            updateCurrentLocationInfo(null);
        }

        // Konum bilgisini g√ºncelle
        function updateCurrentLocationInfo(restaurant) {
            const currentLocationInfo = document.getElementById('currentLocationInfo');
            
            if (restaurant && restaurant.latitude && restaurant.longitude) {
                currentLocationInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="location-badge">üìç ${parseFloat(restaurant.latitude).toFixed(6)}, ${parseFloat(restaurant.longitude).toFixed(6)}</span>
                        <span style="color: #10b981; font-weight: 500;">‚úÖ Konum kayƒ±tlƒ±</span>
                    </div>
                `;
            } else {
                currentLocationInfo.innerHTML = '<p style="margin: 0; color: #666;">üó∫Ô∏è Konum belirtilmemi≈ü</p>';
            }
        }

        // Modal i√ßinden konum se√ßme
        function openLocationPickerFromModal() {
            if (!currentRestaurantId) {
                alert('‚ö†Ô∏è √ñnce restoranƒ± kaydedin, sonra konum se√ßebilirsiniz.');
                return;
            }
            
            // Restoran adƒ±nƒ± modal title'dan al
            const restaurantName = document.getElementById('restaurantName').value || 'Restoran';
            
            openLocationPicker(currentRestaurantId, restaurantName);
        }

        // Restoran ekleme/d√ºzenleme form submit
        document.getElementById('restaurantForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('restaurantName').value,
                yetkili_name: document.getElementById('restaurantYetkili').value,
                phone: document.getElementById('addRestaurantPhone').value,
                email: document.getElementById('restaurantEmail').value
            };

            console.log('üîÑ Form data being sent:', formData);
            console.log('üîÑ Current editing restaurant ID:', currentEditingRestaurantId);

            // ≈ûifre sadece girilmi≈üse ekle (d√ºzenleme sƒ±rasƒ±nda bo≈ü bƒ±rakƒ±labilir)
            const password = document.getElementById('restaurantPassword').value;
            if (password) {
                formData.password = password;
            }

            // D√ºzenleme mi ekleme mi?
            if (currentEditingRestaurantId) {
                // G√ºncelleme i≈ülemi
                fetch(`${API_BASE}/api/admin/restaurants/${currentEditingRestaurantId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Restoran ba≈üarƒ±yla g√ºncellendi');
                        closeRestaurantModal();
                        loadRestaurants();
                    } else {
                        alert(data.message || 'Hata olu≈ütu');
                    }
                })
                .catch(error => {
                    console.error('Restoran g√ºncelleme hatasƒ±:', error);
                    alert('Bir hata olu≈ütu: ' + error.message);
                });
            } else {
                // Ekleme i≈ülemi
                if (!password) {
                    alert('Yeni restoran i√ßin ≈üifre gereklidir');
                    return;
                }
                
                fetch(`${API_BASE}/api/admin/restaurants`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Restoran ba≈üarƒ±yla eklendi');
                        closeRestaurantModal();
                        loadRestaurants();
                    } else {
                        alert(data.message || 'Hata olu≈ütu');
                    }
                })
                .catch(error => {
                    console.error('Restoran ekleme hatasƒ±:', error);
                    alert('Bir hata olu≈ütu: ' + error.message);
                });
            }
        });

        // Restoran d√ºzenle
        function editRestaurant(restaurantId) {
            // Mevcut restoran bilgilerini bul (admin rotasƒ± kullanƒ±lacak)
            fetch(`${API_BASE}/api/admin/restaurants-for-admin`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const restaurant = data.data.find(r => r.id === restaurantId);
                        if (restaurant) {
                            showEditRestaurantModal(restaurantId, restaurant);
                        }
                    }
                })
                .catch(error => {
                    console.error('Restoran bilgileri alƒ±nƒ±rken hata:', error);
                    alert('Restoran bilgileri alƒ±namadƒ±: ' + error.message);
                });
        }

        // Restoran sil
        function deleteRestaurant(restaurantId) {
            if (confirm('Bu restoranƒ± silmek istediƒüinizden emin misiniz?')) {
                // Not implemented yet (admin rotasƒ± kullanƒ±lacak)
                fetch(`${API_BASE}/api/admin/restaurants/${restaurantId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        alert(result.message || 'Restoran ba≈üarƒ±yla silindi');
                        loadRestaurants();
                    } else {
                        alert(result.message || 'Silme hatasƒ±');
                    }
                })
                .catch(error => {
                    console.error('Restoran silme hatasƒ±:', error);
                    alert('Bir hata olu≈ütu: ' + error.message);
                });
            }
        }

        // Restoran ≈üifresi g√∂ster
        function showRestaurantPassword(restaurantId, password) {
            alert(`Restoran #${restaurantId} ≈üifresi:\n\n${password || '≈ûifre bulunamadƒ±'}`);
        }

        // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma
        window.onclick = function(event) {
            const modals = ['deliveryAreasModal', 'editDeliveryAreaModal', 'restaurantModal', 'locationPickerModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'locationPickerModal') {
                        closeLocationPickerModal();
                    } else {
                        modal.style.display = 'none';
                    }
                }
            });
        }

        // =================== MAHALLe ƒ∞STEKLERƒ∞ Y√ñNETƒ∞Mƒ∞ ===================

        // Mahalle isteklerini y√ºkle
        function loadNeighborhoodRequests() {
            console.log('Loading neighborhood requests...');
            fetch(`${API_BASE}/api/admin/neighborhood-requests`, {
                headers: getAuthHeaders()
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP hata! Durum: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Neighborhood requests loaded:', data);
                    if (data.success) {
                        displayNeighborhoodRequests(data.data);
                    } else {
                        throw new Error(data.message || 'Bilinmeyen hata');
                    }
                })
                .catch(error => {
                    console.error('Mahalle istekleri y√ºklenirken hata:', error);
                    document.getElementById('neighborhoodRequestsTable').innerHTML = 
                        '<tr><td colspan="8" style="color: red; text-align: center;">Y√ºkleme hatasƒ±: ' + error.message + '</td></tr>';
                });
        }

        // Mahalle isteklerini g√∂ster
        function displayNeighborhoodRequests(requests) {
            console.log('Displaying neighborhood requests:', requests);
            const tbody = document.getElementById('neighborhoodRequestsTable');
            
            if (!requests || requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">Mahalle isteƒüi bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(request => {
                const statusBadge = getStatusBadge(request.status);
                const actionButtons = getActionButtons(request);
                
                return `
                <tr>
                    <td>${request.id}</td>
                    <td>${request.restaurant_name || 'Bilinmeyen'}</td>
                    <td>${request.neighborhood_name}</td>
                    <td>‚Ç∫${parseFloat(request.restaurant_price || 0).toFixed(2)}</td>
                    <td>${request.courier_price ? '‚Ç∫' + parseFloat(request.courier_price).toFixed(2) : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(request.created_at).toLocaleDateString('tr-TR')}</td>
                    <td class="actions">${actionButtons}</td>
                </tr>`;
            }).join('');
        }

        // Durum badge'ini d√∂nd√ºr
        function getStatusBadge(status) {
            switch(status) {
                case 'pending':
                    return '<span class="badge" style="background: #fef3c7; color: #92400e;">‚è≥ Beklemede</span>';
                case 'approved':
                    return '<span class="badge" style="background: #d1fae5; color: #065f46;">‚úÖ Onaylandƒ±</span>';
                case 'rejected':
                    return '<span class="badge" style="background: #fee2e2; color: #991b1b;">‚ùå Reddedildi</span>';
                default:
                    return '<span class="badge" style="background: #f3f4f6; color: #374151;">‚ùì Bilinmiyor</span>';
            }
        }

        // ƒ∞≈ülem butonlarƒ±nƒ± d√∂nd√ºr
        function getActionButtons(request) {
            if (request.status === 'pending') {
                return `
                    <button class="btn btn-success" onclick="showApprovalModal(${request.id})" title="Onayla">
                        ‚úÖ Onayla
                    </button>
                    <button class="btn btn-danger" onclick="rejectNeighborhoodRequest(${request.id})" title="Reddet">
                        ‚ùå Reddet
                    </button>
                `;
            } else {
                return `<span style="color: #666;">ƒ∞≈ülem yapƒ±ldƒ±</span>`;
            }
        }

        // Onaylama modal'ƒ±nƒ± g√∂ster
        function showApprovalModal(requestId) {
            console.log('Showing approval modal for request:', requestId);
            currentRequestId = requestId;
            
            // Request'i bul
            fetch(`${API_BASE}/api/admin/neighborhood-requests`, {
                headers: getAuthHeaders()
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const request = data.data.find(r => r.id === requestId);
                        if (request) {
                            const restaurantPrice = parseFloat(request.restaurant_price || 0);
                            
                            document.getElementById('approvalRequestInfo').innerHTML = `
                                <h4>üìã Talep Detaylarƒ±</h4>
                                <p><strong>Restoran:</strong> ${request.restaurant_name || 'Bilinmeyen'}</p>
                                <p><strong>Mahalle:</strong> ${request.neighborhood_name}</p>
                                <p><strong>Restoran Fiyatƒ±:</strong> <span style="color: #10b981; font-weight: bold;">‚Ç∫${restaurantPrice.toFixed(2)}</span></p>
                                <p><strong>Talep Tarihi:</strong> ${new Date(request.created_at).toLocaleString('tr-TR')}</p>
                            `;
                            
                            // Kurye fiyatƒ±nƒ± temizle ve maksimum deƒüeri ayarla
                            const courierPriceInput = document.getElementById('approvalCourierPrice');
                            courierPriceInput.value = '';
                            courierPriceInput.max = restaurantPrice; // Maksimum deƒüeri ayarla
                            courierPriceInput.setAttribute('data-restaurant-price', restaurantPrice);
                            
                            // Maksimum fiyat bilgisini g√ºncelle
                            document.getElementById('maxPriceInfo').textContent = `Maksimum: ‚Ç∫${restaurantPrice.toFixed(2)}`;
                            
                            // Real-time validation ekle
                            courierPriceInput.addEventListener('input', validateCourierPrice);
                            
                            // Modal'ƒ± a√ß
                            document.getElementById('approvalModal').style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Request detaylarƒ± alƒ±nƒ±rken hata:', error);
                    alert('Talep detaylarƒ± alƒ±namadƒ±: ' + error.message);
                });
        }

        // Kurye fiyatƒ± validasyonu
        function validateCourierPrice() {
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            const approveBtn = document.getElementById('approveBtn');
            const priceWarning = document.getElementById('priceWarning');
            
            const courierPrice = parseFloat(courierPriceInput.value);
            const restaurantPrice = parseFloat(courierPriceInput.getAttribute('data-restaurant-price'));
            
            if (courierPrice > restaurantPrice) {
                // Kurye fiyatƒ± √ßok y√ºksek
                courierPriceInput.style.borderColor = '#ef4444';
                priceWarning.style.color = '#ef4444';
                priceWarning.textContent = '‚ö†Ô∏è Kurye fiyatƒ± restoran fiyatƒ±ndan y√ºksek olamaz!';
                approveBtn.disabled = true;
                approveBtn.style.opacity = '0.5';
            } else if (courierPrice <= 0) {
                // Kurye fiyatƒ± sƒ±fƒ±r veya negatif
                courierPriceInput.style.borderColor = '#ef4444';
                priceWarning.style.color = '#ef4444';
                priceWarning.textContent = '‚ö†Ô∏è Kurye fiyatƒ± 0\'dan b√ºy√ºk olmalƒ±dƒ±r!';
                approveBtn.disabled = true;
                approveBtn.style.opacity = '0.5';
            } else {
                // Ge√ßerli fiyat
                courierPriceInput.style.borderColor = '#10b981';
                priceWarning.style.color = '#10b981';
                priceWarning.textContent = '‚úÖ Kurye fiyatƒ± uygun';
                approveBtn.disabled = false;
                approveBtn.style.opacity = '1';
            }
        }

        // Onaylama form submit
        document.getElementById('approvalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            const courierPrice = parseFloat(courierPriceInput.value);
            const restaurantPrice = parseFloat(courierPriceInput.getAttribute('data-restaurant-price'));
            
            // Validation kontrol√º
            if (!courierPrice || courierPrice <= 0) {
                alert('‚ö†Ô∏è Ge√ßerli bir kurye fiyatƒ± girin!');
                return;
            }
            
            if (courierPrice > restaurantPrice) {
                alert(`‚ö†Ô∏è Kurye fiyatƒ± restoran fiyatƒ±ndan (‚Ç∫${restaurantPrice.toFixed(2)}) y√ºksek olamaz!`);
                return;
            }
            
            approveNeighborhoodRequest(currentRequestId, courierPrice);
        });

        // Mahalle talebini onayla
        function approveNeighborhoodRequest(requestId, courierPrice) {
            console.log('Approving neighborhood request:', requestId, 'with courier price:', courierPrice);
            
            fetch(`${API_BASE}/api/admin/neighborhood-requests/${requestId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    status: 'approved',
                    courier_price: courierPrice
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mahalle talebi ba≈üarƒ±yla onaylandƒ±! Teslimat alanlarƒ±na eklendi.');
                    closeApprovalModal();
                    loadNeighborhoodRequests();
                    loadRestaurants(); // Restoran listesini yenile (delivery_areas_count g√ºncellenecek)
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Mahalle talebi onaylanƒ±rken hata:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Mahalle talebini reddet
        function rejectNeighborhoodRequest(requestId) {
            if (!confirm('Bu mahalle talebini reddetmek istediƒüinize emin misiniz?')) {
                return;
            }
            
            console.log('Rejecting neighborhood request:', requestId);
            
            fetch(`${API_BASE}/api/admin/neighborhood-requests/${requestId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    status: 'rejected',
                    courier_price: 0
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP hata! Durum: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Mahalle talebi reddedildi.');
                    closeApprovalModal();
                    loadNeighborhoodRequests();
                } else {
                    alert(data.message || 'Hata olu≈ütu');
                }
            })
            .catch(error => {
                console.error('Mahalle talebi reddedilirken hata:', error);
                alert('Bir hata olu≈ütu: ' + error.message);
            });
        }

        // Onaylama modal'ƒ±nƒ± kapat
        function closeApprovalModal() {
            document.getElementById('approvalModal').style.display = 'none';
            currentRequestId = null;
            
            // Input'u temizle ve stili sƒ±fƒ±rla
            const courierPriceInput = document.getElementById('approvalCourierPrice');
            courierPriceInput.value = '';
            courierPriceInput.style.borderColor = '';
            courierPriceInput.removeAttribute('max');
            courierPriceInput.removeAttribute('data-restaurant-price');
            courierPriceInput.removeEventListener('input', validateCourierPrice);
            
            // Buton ve mesajlarƒ± sƒ±fƒ±rla
            const approveBtn = document.getElementById('approveBtn');
            approveBtn.disabled = false;
            approveBtn.style.opacity = '1';
            
            const priceWarning = document.getElementById('priceWarning');
            priceWarning.style.color = '#666';
            priceWarning.textContent = 'Kurye fiyatƒ± restoran fiyatƒ±ndan y√ºksek olamaz.';
            
            document.getElementById('maxPriceInfo').textContent = 'Maksimum: ‚Ç∫0.00';
        }
    </script>
</body>
</html> 