<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö Kurye App - Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .nav-link:hover { background: #5a67d8; }
        .nav-link.active { background: #4c51bf; }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .card-title { font-size: 1.2rem; font-weight: 600; color: #333; }
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th {
            background: #f8fafc;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
        }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .refresh-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #059669; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/main-layout.js"></script>
</head>
<body>
    <div class="container">
        <!-- THE HEADER IS NOW DYNAMICALLY INSERTED HERE BY main-layout.js -->

        <div class="main-content">
            <!-- En ƒ∞yi Performans Tablolarƒ± -->
            <div class="chart-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üèÜ En √áok Sipari≈ü Alan Restoranlar</h3>
                        <button class="refresh-btn" onclick="loadTopRestaurants()">üîÑ</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Restoran Adƒ±</th>
                                    <th>Toplam Sipari≈ü</th>
                                </tr>
                            </thead>
                            <tbody id="topRestaurantsTable">
                                <tr><td colspan="3" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üö¥ Kurye Performans Analizi</h3>
                        <button class="refresh-btn" onclick="loadTopCouriers()">üîÑ</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Kurye Adƒ±</th>
                                    <th>Toplam Sipari≈ü</th>
                                    <th>Ortalama Teslimat</th>
                                    <th>Performans</th>
                                </tr>
                            </thead>
                            <tbody id="topCouriersTable">
                                <tr><td colspan="5" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- En √áok Kazandƒ±ran Restoranlar Tablosu (Yeni Eklendi) -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üí∞ En √áok Kazandƒ±ran Restoranlar (Platform Karƒ±)</h3>
                        <button class="refresh-btn" onclick="loadTopEarningRestaurants()">üîÑ</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Restoran Adƒ±</th>
                                    <th>Platform Karƒ±</th>
                                </tr>
                            </thead>
                            <tbody id="topEarningRestaurantsTable">
                                <tr><td colspan="3" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // üîê Admin ≈üifre kontrol√º
        function checkAdminAuth() {
            if (localStorage.getItem('adminAuth') !== 'authenticated') {
                window.location.href = 'admin-login.html';
                return false;
            }
            return true;
        }
        
        // Sayfa y√ºklendiƒüinde ≈üifre kontrol et
        if (!checkAdminAuth()) {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: white; font-size: 1.2rem;">üîê Yetki kontrol√º yapƒ±lƒ±yor...</div>';
        }

        let API_BASE; // API_BASE'i global olarak tanƒ±mlayƒ±n, ancak hemen atama yapmayƒ±n

        // API_BASE'i arka u√ßtan √ßekme fonksiyonu
        async function fetchApiBase() {
            try {
                const response = await fetch('/api/admin/config/api-base-url');
                const data = await response.json();
                if (data.success && data.apiBaseUrl) {
                    API_BASE = data.apiBaseUrl;
                    console.log('API_BASE ba≈üarƒ±yla ayarlandƒ±:', API_BASE);
                } else {
                    console.error('API_BASE backend tarafƒ±ndan saƒülanamadƒ±:', data.message || 'Bilinmeyen Hata');
                    API_BASE = 'https://kuryex.enucuzal.com'; // Use production HTTPS
                }
            } catch (error) {
                console.error('API_BASE y√ºklenirken hata olu≈ütu:', error);
                API_BASE = 'https://kuryex.enucuzal.com'; // Use production HTTPS on error
            }
        }

        // Helper function to get authorization headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return { 'Content-Type': 'application/json' };
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await fetchApiBase(); // Fetch API_BASE first
            loadTopRestaurants();
            loadTopCouriers();
            loadTopEarningRestaurants(); // Yeni fonksiyonu √ßaƒüƒ±r
        });

        // En √áok Sipari≈ü Alan Restoranlarƒ± Y√ºkle
        async function loadTopRestaurants() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/analytics/top-restaurants`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const tbody = document.getElementById('topRestaurantsTable');

                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map((restaurant, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${restaurant.firma_adi || restaurant.name || 'N/A'}</td>
                            <td>${restaurant.total_orders || 0}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">Veri bulunamadƒ±.</td></tr>';
                }
            } catch (error) {
                console.error('En √ßok sipari≈ü alan restoranlar y√ºklenirken hata:', error);
                document.getElementById('topRestaurantsTable').innerHTML = '<tr><td colspan="3" class="loading">Y√ºkleme hatasƒ±.</td></tr>';
            }
        }

        // Kurye Performans Analizini Y√ºkle
        async function loadTopCouriers() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/analytics/top-couriers`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const tbody = document.getElementById('topCouriersTable');

                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map((courier, index) => {
                        const avgTime = Math.round(courier.avg_delivery_time_minutes || 0);
                        const totalOrders = courier.total_orders || 0;
                        
                        // Performans deƒüerlendirmesi (basit algoritma)
                        let performanceRating = '‚≠ê';
                        let performanceColor = '#f59e0b';
                        
                        if (avgTime > 0) {
                            if (avgTime <= 20 && totalOrders >= 10) {
                                performanceRating = 'üèÜ M√ºkemmel';
                                performanceColor = '#059669';
                            } else if (avgTime <= 30 && totalOrders >= 5) {
                                performanceRating = 'ü•á √áok ƒ∞yi';
                                performanceColor = '#0891b2';
                            } else if (avgTime <= 45) {
                                performanceRating = 'ü•à ƒ∞yi';
                                performanceColor = '#65a30d';
                            } else {
                                performanceRating = 'ü•â Geli≈üir';
                                performanceColor = '#dc2626';
                            }
                        }
                        
                        return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${courier.name || 'N/A'}</td>
                            <td><span style="font-weight: 600; color: #1f2937;">${totalOrders}</span></td>
                            <td>
                                <span style="color: #059669; font-weight: 600;">
                                    ${avgTime > 0 ? avgTime + ' dk' : 'Veri yok'}
                                </span>
                            </td>
                            <td>
                                <span style="color: ${performanceColor}; font-weight: 600;">
                                    ${performanceRating}
                                </span>
                            </td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">Veri bulunamadƒ±.</td></tr>';
                }
            } catch (error) {
                console.error('Kurye performans analizi y√ºklenirken hata:', error);
                document.getElementById('topCouriersTable').innerHTML = '<tr><td colspan="5" class="loading">Y√ºkleme hatasƒ±.</td></tr>';
            }
        }

        // En √áok Kazandƒ±ran Restoranlarƒ± Y√ºkle (Yeni Eklendi)
        async function loadTopEarningRestaurants() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/analytics/top-earning-restaurants`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                const tbody = document.getElementById('topEarningRestaurantsTable');

                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map((restaurant, index) => `
                <tr>
                    <td>${index + 1}</td>
                            <td>${restaurant.firma_adi || restaurant.name || 'N/A'}</td>
                            <td>‚Ç∫${(parseFloat(restaurant.platform_profit) || 0).toFixed(2)}</td>
                </tr>
            `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">Veri bulunamadƒ±.</td></tr>';
                }
            } catch (error) {
                console.error('En √ßok kazandƒ±ran restoranlar y√ºklenirken hata:', error);
                document.getElementById('topEarningRestaurantsTable').innerHTML = '<tr><td colspan="3" class="loading">Y√ºkleme hatasƒ±.</td></tr>';
            }
        }

    </script>
</body>
</html> 